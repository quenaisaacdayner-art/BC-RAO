---
phase: 05-monitoring-feedback-loop
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - bc-rao-frontend/lib/campaign-stages.ts
  - bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx
  - bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/[draftId]/edit/page.tsx
autonomous: true

must_haves:
  truths:
    - "Stage 5 (Deployment & Monitoring) appears in campaign stage indicator after Stage 4"
    - "Stage 5 is locked until drafts are generated (Stage 4 complete)"
    - "Stage 5 links to the monitoring page for the campaign"
    - "Draft editor has 'I posted this' button that opens URL registration flow"
    - "Campaign page shows Stage 5 content when previous stages complete"
  artifacts:
    - path: "bc-rao-frontend/lib/campaign-stages.ts"
      provides: "Updated stage definitions with Stage 5"
      contains: "Deployment & Monitoring"
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx"
      provides: "Campaign page with Stage 5 content section"
      contains: "monitoring"
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/[draftId]/edit/page.tsx"
      provides: "Draft editor with 'I posted this' button"
      contains: "posted"
  key_links:
    - from: "bc-rao-frontend/lib/campaign-stages.ts"
      to: "bc-rao-frontend/components/dashboard/StageIndicator.tsx"
      via: "computeStages returns Stage 5 in array"
      pattern: "id: 5"
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/[draftId]/edit/page.tsx"
      to: "/api/monitoring"
      via: "POST registration from draft editor button"
      pattern: "api/monitoring"
---

<objective>
Add Stage 5 (Deployment & Monitoring) to the campaign journey and integrate the "I posted this" button into the draft editor. This connects the generation phase to the monitoring phase through two entry points per user decision.

Purpose: Stage 5 completes the campaign journey from creation to monitoring. The "I posted this" button in the draft editor is one of two post registration entry points (the other being the monitoring page URL paste from Plan 03).

Output: Updated campaign stages with Stage 5, campaign page Stage 5 content, and draft editor post registration button.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-monitoring-feedback-loop/05-CONTEXT.md
@.planning/phases/05-monitoring-feedback-loop/05-02-SUMMARY.md

@bc-rao-frontend/lib/campaign-stages.ts
@bc-rao-frontend/components/dashboard/StageIndicator.tsx
@bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx
@bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/[draftId]/edit/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Stage 5 to campaign journey + campaign page content</name>
  <files>
    bc-rao-frontend/lib/campaign-stages.ts
    bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx
  </files>
  <action>
**lib/campaign-stages.ts** — Add Stage 5 (LOCKED: single stage "Deployment & Monitoring"):

1. Update `CampaignStage` interface: change `id` type from `1 | 2 | 3 | 4` to `1 | 2 | 3 | 4 | 5`

2. Add `monitored_posts?: number` to the Campaign.stats interface (to track monitoring state)

3. In `computeStages()` function, add Stage 5 after Stage 4:
   ```
   // Stage 5: Deployment & Monitoring - completed when posts are being monitored
   const stage5Complete = (campaign.stats.monitored_posts ?? 0) > 0;
   ```

   Add to the stages array:
   ```
   {
     id: 5,
     name: "Deployment & Monitoring",
     description: "Post on Reddit, register URL, track performance",
     completed: stage5Complete,
     active: stage4Complete && !stage5Complete,
     url: `/dashboard/campaigns/${campaignId}/monitoring`,
     locked: !stage4Complete,  // Locked until Stage 4 (drafts generated)
   }
   ```

4. Update `getStageUrl()`: Add `5: /dashboard/campaigns/${campaignId}/monitoring` to the baseUrls record.

5. Update `getCurrentStage()`: Change default return from 4 to 5 if all complete.

**app/dashboard/campaigns/[id]/page.tsx** — Add Stage 5 content section:

Read the existing file first. It currently shows Stage 4 content (generate button + recent drafts). Add a Stage 5 section below Stage 4's section:

When Stage 5 is active (stage4Complete is true):
- Show a "Deployment & Monitoring" card section
- Content: "Ready to deploy? Post your approved drafts on Reddit, then register the URL here or on the monitoring page to start tracking."
- Show a "Go to Monitoring" button linking to `/dashboard/campaigns/{id}/monitoring`
- Show count of monitored posts if any exist (from campaign stats)
- If Stage 5 is locked: show the locked card with "Complete previous stages first" message (follow same pattern as existing locked stage cards)

Ensure the `stats` object passed to `computeStages()` includes `monitored_posts` — fetch from the monitoring dashboard endpoint or default to 0 if not available.
  </action>
  <verify>
    Run: cd bc-rao-frontend && npx next build 2>&1 | tail -20
    Verify build succeeds with updated campaign-stages.ts types.
  </verify>
  <done>
    Stage 5 "Deployment & Monitoring" appears in campaign stage indicator after Stage 4. Locked until drafts generated. Links to monitoring page. Campaign page shows Stage 5 content card with "Go to Monitoring" CTA when active. Campaign stats includes monitored_posts count.
  </done>
</task>

<task type="auto">
  <name>Task 2: "I posted this" button on draft editor</name>
  <files>
    bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/[draftId]/edit/page.tsx
  </files>
  <action>
Read the existing draft editor page. Add an "I posted this" button as a second entry point for post registration (LOCKED user decision: two entry points).

**Draft editor integration:**

1. Add "I posted this" button to the draft editor page — place it in the action buttons area (near approve/discard/regenerate/copy buttons). Only show this button when the draft status is "approved" or "posted" (not for "generated" or "discarded" drafts).

2. Button click behavior:
   - Opens a small inline dialog/popover or expands a section below the button (NOT a full modal — keep it lightweight since user is still on the editor page)
   - Shows an input field: "Paste the Reddit URL where you posted this draft"
   - Submit button: "Start Monitoring"
   - On submit:
     a. Validate URL format client-side (same Reddit URL regex as monitoring page)
     b. POST to `/api/monitoring` with `{ post_url: url, campaign_id: campaignId }`
     c. On success: show toast "Post registered! Monitoring has started." with action button "View Monitoring" linking to monitoring page
     d. Update draft status to "posted" via PATCH to drafts API if current status is "approved"
     e. On error: show error toast (invalid URL or duplicate)

3. If draft already has a monitored post associated (draft status is "posted" and a shadow entry exists), show "Monitoring Active" badge instead of the button, with a link to the monitoring page.

4. Style: Use existing button variants from the project. "I posted this" button should use outline variant with a distinctive icon (ExternalLink or Rocket from lucide-react). The URL input section should be visually distinct (light background, bordered).

5. The button needs campaign_id from the page params (already available in the edit page via route params).
  </action>
  <verify>
    Run: cd bc-rao-frontend && npx next build 2>&1 | tail -20
    Verify draft editor page compiles with the new button.
  </verify>
  <done>
    Draft editor shows "I posted this" button for approved/posted drafts. Button expands URL input inline, validates Reddit URL, registers post for monitoring via API, shows success toast with link to monitoring page, and auto-updates draft status to "posted". Already-monitored drafts show "Monitoring Active" badge instead.
  </done>
</task>

</tasks>

<verification>
1. campaign-stages.ts exports Stage 5 with correct id, name, description, URL
2. Stage 5 locked until Stage 4 complete (drafts generated)
3. StageIndicator renders 5 stages without visual breakage
4. Campaign page shows Stage 5 content section
5. Draft editor shows "I posted this" button for approved drafts
6. Button submits URL to monitoring API and shows success toast
7. Both files compile without TypeScript errors
</verification>

<success_criteria>
- Stage 5 "Deployment & Monitoring" visible in stage indicator (LOCKED: single stage per user decision)
- Stage 5 links to /dashboard/campaigns/{id}/monitoring
- "I posted this" button appears on draft editor for approved/posted drafts (LOCKED: two entry points per user decision)
- URL registration from draft editor redirects intent to monitoring page via toast action
- Campaign page Stage 5 section shows when active with "Go to Monitoring" CTA
</success_criteria>

<output>
After completion, create `.planning/phases/05-monitoring-feedback-loop/05-04-SUMMARY.md`
</output>

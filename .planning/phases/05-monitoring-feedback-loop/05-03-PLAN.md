---
phase: 05-monitoring-feedback-loop
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - bc-rao-frontend/app/api/monitoring/route.ts
  - bc-rao-frontend/app/api/monitoring/[id]/route.ts
  - bc-rao-frontend/app/api/monitoring/dashboard/route.ts
  - bc-rao-frontend/app/dashboard/campaigns/[id]/monitoring/page.tsx
  - bc-rao-frontend/components/monitoring/MonitoringStats.tsx
  - bc-rao-frontend/components/monitoring/PostCard.tsx
  - bc-rao-frontend/components/monitoring/ShadowbanAlert.tsx
  - bc-rao-frontend/components/monitoring/StatusFilter.tsx
autonomous: false

must_haves:
  truths:
    - "User can view monitoring dashboard with active/removed/shadowbanned counts and success rate"
    - "User can see monitored post cards with title, subreddit, status badge, and time since posted"
    - "User can filter monitored posts by status (All/Active/Removed/Shadowbanned)"
    - "User can expand a post card inline to see check history, ISC snapshot, and outcome classification"
    - "User sees full-screen shadowban alert modal on first dashboard visit after detection"
    - "User can register a new post URL from the monitoring page"
  artifacts:
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/monitoring/page.tsx"
      provides: "Monitoring dashboard page with stats, URL registration, post list, and alerts"
      min_lines: 80
    - path: "bc-rao-frontend/components/monitoring/MonitoringStats.tsx"
      provides: "4-card stats header (active, removed, shadowbanned, success rate)"
      min_lines: 30
    - path: "bc-rao-frontend/components/monitoring/PostCard.tsx"
      provides: "Expandable accordion post card with check history, ISC, patterns"
      min_lines: 50
    - path: "bc-rao-frontend/components/monitoring/ShadowbanAlert.tsx"
      provides: "Full-screen AlertDialog for shadowban detection"
      min_lines: 40
  key_links:
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/monitoring/page.tsx"
      to: "/api/monitoring"
      via: "fetch calls to proxy routes"
      pattern: "fetch.*api/monitoring"
    - from: "bc-rao-frontend/app/api/monitoring/route.ts"
      to: "FastAPI /api/v1/monitoring"
      via: "proxy to backend API"
      pattern: "API_URL.*monitoring"
    - from: "bc-rao-frontend/components/monitoring/ShadowbanAlert.tsx"
      to: "monitoring page state"
      via: "isOpen prop controlled by parent"
      pattern: "AlertDialog.*open"
---

<objective>
Build the complete frontend monitoring dashboard: API proxy routes, monitoring page with URL registration form, stats header, expandable post cards with status filtering, and full-screen shadowban alert modal.

Purpose: This is the user-facing interface for the entire monitoring system. Users register posts, track status, review check history, and receive critical alerts — all on this page. Per user decision, this includes the standalone URL paste entry point for post registration.

Output: 3 Next.js API proxy routes, 1 monitoring page, and 4 React components.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-monitoring-feedback-loop/05-CONTEXT.md
@.planning/phases/05-monitoring-feedback-loop/05-RESEARCH.md
@.planning/phases/05-monitoring-feedback-loop/05-02-SUMMARY.md

@bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx
@bc-rao-frontend/app/api/collection/route.ts
@bc-rao-frontend/components/ui/badge.tsx
@bc-rao-frontend/components/ui/card.tsx
@bc-rao-frontend/components/ui/tabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: API proxy routes + shadcn components install</name>
  <files>
    bc-rao-frontend/app/api/monitoring/route.ts
    bc-rao-frontend/app/api/monitoring/[id]/route.ts
    bc-rao-frontend/app/api/monitoring/dashboard/route.ts
  </files>
  <action>
First, install required shadcn components that are not yet in the project:
```
npx shadcn@latest add accordion alert-dialog
```
(badge and tabs already exist in the project)

**app/api/monitoring/route.ts** — Proxy for list + register endpoints:
- `GET` handler: Forward to FastAPI `GET /api/v1/monitoring/posts?campaign_id=...&status=...`. Extract query params, pass auth cookie/header. Return JSON response.
- `POST` handler: Forward to FastAPI `POST /api/v1/monitoring/register`. Parse JSON body, pass to backend. Return 201/400/409 responses.
- Follow exact same proxy pattern as existing `app/api/collection/route.ts` and `app/api/drafts/route.ts`.

**app/api/monitoring/[id]/route.ts** — Proxy for single post detail:
- `GET` handler: Forward to FastAPI `GET /api/v1/monitoring/{id}`. Pass auth. Return JSON.

**app/api/monitoring/dashboard/route.ts** — Proxy for dashboard stats:
- `GET` handler: Forward to FastAPI `GET /api/v1/monitoring/dashboard?campaign_id=...`. Pass auth. Return JSON.

All proxies: extract Supabase auth token from cookies, set as Authorization Bearer header to FastAPI, handle errors with appropriate status codes. Use `process.env.NEXT_PUBLIC_API_URL` for backend base URL.
  </action>
  <verify>
    Check that all three route files exist and the accordion + alert-dialog components are installed:
    ls bc-rao-frontend/app/api/monitoring/ && ls bc-rao-frontend/components/ui/accordion.tsx && ls bc-rao-frontend/components/ui/alert-dialog.tsx
  </verify>
  <done>
    3 API proxy routes created matching existing proxy patterns. Accordion and AlertDialog shadcn components installed. All routes forward auth and return proper status codes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Monitoring page with components (stats, cards, filters, alert, registration)</name>
  <files>
    bc-rao-frontend/app/dashboard/campaigns/[id]/monitoring/page.tsx
    bc-rao-frontend/components/monitoring/MonitoringStats.tsx
    bc-rao-frontend/components/monitoring/PostCard.tsx
    bc-rao-frontend/components/monitoring/ShadowbanAlert.tsx
    bc-rao-frontend/components/monitoring/StatusFilter.tsx
  </files>
  <action>
**components/monitoring/MonitoringStats.tsx** — Stats header (LOCKED: active/removed/shadowbanned counts + success rate):
- 4-card grid layout (grid-cols-1 md:grid-cols-4 gap-4)
- Card 1: "Active" count with green accent
- Card 2: "Removed" count with gray/secondary accent
- Card 3: "Shadowbanned" count with red/destructive accent
- Card 4: "Success Rate" percentage with subtext "{active} of {total} posts live"
- Props: `stats: { active: number, removed: number, shadowbanned: number, total: number, success_rate: number }`
- Follow existing Card component patterns from the project

**components/monitoring/StatusFilter.tsx** — Filter tabs (LOCKED: tabs or chips for All/Active/Removed/Shadowbanned):
- Use shadcn Tabs component (already installed)
- TabsList with 4 TabsTrigger: "All", "Active", "Removed", "Shadowbanned"
- Props: `value: string, onChange: (status: string) => void`
- "All" passes empty string (no filter)
- Each tab shows count badge next to label

**components/monitoring/PostCard.tsx** — Expandable accordion card (LOCKED: click to expand inline):
- Use shadcn Accordion + Card components
- Collapsed view: post title (left), subreddit (r/name below title), status Badge (right), time since posted (formatDistanceToNow or manual relative time calculation)
- Status badge variants: "active" -> default/green, "removed" -> secondary/gray, "shadowbanned" -> destructive/red, "audited" -> outline
- Expanded view (AccordionContent):
  - Check History section: list of checks with timestamp, auth status, anon status as small badges
  - ISC at Posting: single number display
  - Outcome Classification (if audited): SocialSuccess green badge / Rejection red badge / Inertia gray badge
  - Pattern Analysis (if removed/shadowbanned): text note "Auto-extracted patterns added to blacklist" with link to `/dashboard/campaigns/{id}/blacklist`
- Props: `post: ShadowEntry` (matching the API response shape)
- `type="single" collapsible` so only one card expanded at a time
- Map status_vida enum values: "Ativo" -> "active", "Removido" -> "removed", "Shadowbanned" -> "shadowbanned", "Auditado" -> "audited"

**components/monitoring/ShadowbanAlert.tsx** — Full-screen modal (LOCKED: full-screen on first visit, then dismissable banner):
- Use shadcn AlertDialog component
- Props: `isOpen: boolean`, `onDismiss: () => void`, `postTitle: string`, `subreddit: string`, `detectedAt: string`
- Header: large red "Shadowban Detected" title
- Body: red-tinted info box with post details, "What This Means" explanation, 4 numbered immediate actions (pause 48h, review patterns, check blacklist, don't delete post), note about auto-extracted patterns
- Footer: single destructive-colored "I Understand -- View Dashboard" button that calls onDismiss
- Parent tracks dismissed state in localStorage key `shadowban_alert_dismissed_{shadow_id}` — show modal only once per shadowban event

**app/dashboard/campaigns/[id]/monitoring/page.tsx** — Main monitoring page:
- "use client" directive
- URL registration section at top:
  - Input field with placeholder "Paste your Reddit post URL here..."
  - "Register Post" button next to input
  - On submit: validate URL client-side (Reddit URL regex), POST to `/api/monitoring` with `{post_url, campaign_id}`, show toast on success ("Post registered! Monitoring started."), refetch posts list
  - Show error toast on invalid URL or duplicate
- MonitoringStats component below registration
- StatusFilter tabs below stats
- PostCard list below filter, filtered by selected status
- ShadowbanAlert modal: check if any post has status "Shadowbanned" and hasn't been dismissed (check localStorage). If found, show modal.
- Data fetching: useEffect to GET `/api/monitoring/dashboard?campaign_id={id}` for stats, GET `/api/monitoring?campaign_id={id}&status={filter}` for posts. Use useState for loading states.
- Add polling: refetch posts every 30 seconds (setInterval) to pick up status changes from background monitoring.
- Empty state: "No monitored posts yet. Post a draft on Reddit and paste the URL above to start monitoring."
- Page title: "Post Monitoring" with campaign name subtitle
  </action>
  <verify>
    Run: cd bc-rao-frontend && npx next build 2>&1 | tail -20
    Verify monitoring page compiles without TypeScript errors.
  </verify>
  <done>
    Monitoring dashboard displays stats header (4 cards), status filter tabs, expandable post cards with check history/ISC/outcome/patterns, full-screen shadowban alert modal (shown once per event via localStorage), and URL registration form with validation. Posts list polls every 30 seconds for real-time updates.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete monitoring dashboard with URL registration, stats, filterable post cards, and shadowban alert modal</what-built>
  <how-to-verify>
    1. Navigate to a campaign page and click through to the monitoring section
    2. Verify the URL registration input is visible at the top
    3. Try pasting an invalid URL -- should show error toast
    4. Verify the stats header shows 4 cards (Active, Removed, Shadowbanned, Success Rate) -- will show zeros for fresh campaign
    5. Verify the status filter tabs (All/Active/Removed/Shadowbanned) are visible
    6. Verify the empty state message appears when no posts are monitored
    7. Check that the page layout matches the design: stats at top, filters below, cards below that
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. shadcn accordion and alert-dialog components installed
2. 3 API proxy routes exist and forward to correct FastAPI endpoints
3. Monitoring page renders with stats header, filter tabs, post card list, and URL registration form
4. PostCard expands inline showing check history and ISC snapshot
5. ShadowbanAlert modal renders with correct content and dismisses properly
6. StatusFilter tabs correctly filter post list
7. Next.js build compiles without TypeScript errors
</verification>

<success_criteria>
- Stats header shows active/removed/shadowbanned/success_rate (per LOCKED decision)
- Post cards show title, subreddit, status badge, time since posted (per LOCKED decision)
- Filter by status works with tabs (per LOCKED decision)
- Click card expands inline with check history, ISC, outcome, patterns (per LOCKED decision)
- Full-screen shadowban modal shows on first visit after detection (per LOCKED decision)
- URL registration form validates Reddit URL format and submits to API
- Toast notification on successful registration (per LOCKED decision)
</success_criteria>

<output>
After completion, create `.planning/phases/05-monitoring-feedback-loop/05-03-SUMMARY.md`
</output>

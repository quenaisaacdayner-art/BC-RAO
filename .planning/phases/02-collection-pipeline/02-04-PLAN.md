---
phase: 02-collection-pipeline
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - bc-rao-frontend/components/collection/PostGrid.tsx
  - bc-rao-frontend/components/collection/PostFilters.tsx
  - bc-rao-frontend/components/collection/PostDetailModal.tsx
  - bc-rao-frontend/components/collection/FunnelStats.tsx
  - bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx
  - bc-rao-frontend/components/sidebar/nav-items.ts
autonomous: false

must_haves:
  truths:
    - "User can view collected posts in a card grid layout with title, snippet, archetype badge, score, and subreddit"
    - "User can filter posts by archetype dropdown, subreddit dropdown, and score range slider"
    - "User can click a card to see full post detail in a modal with text, metadata, archetype, and score"
    - "User sees archetypes as grouped sections with counts"
    - "User sees detailed funnel breakdown with expandable filter reasons"
    - "User can click 'Collect More' to append new posts with deduplication"
    - "Remaining collection runs shown on Collect More button"
  artifacts:
    - path: "bc-rao-frontend/components/collection/PostGrid.tsx"
      provides: "Card grid component with Reddit-style post cards"
      min_lines: 60
    - path: "bc-rao-frontend/components/collection/PostFilters.tsx"
      provides: "Filter bar with archetype dropdown, subreddit dropdown, score range slider"
      min_lines: 40
    - path: "bc-rao-frontend/components/collection/PostDetailModal.tsx"
      provides: "Modal showing full post text, metadata, archetype, success score"
      min_lines: 50
    - path: "bc-rao-frontend/components/collection/FunnelStats.tsx"
      provides: "Funnel breakdown visualization: scraped -> filtered -> classified"
      min_lines: 30
  key_links:
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx"
      to: "bc-rao-frontend/components/collection/PostGrid.tsx"
      via: "import and render in results view"
      pattern: "import.*PostGrid"
    - from: "bc-rao-frontend/components/collection/PostGrid.tsx"
      to: "FastAPI /v1/collection/campaigns/{id}/posts"
      via: "fetch with filter params"
      pattern: "fetch.*posts"
    - from: "bc-rao-frontend/components/collection/PostDetailModal.tsx"
      to: "FastAPI /v1/collection/campaigns/{id}/posts/{post_id}"
      via: "fetch post detail on card click"
      pattern: "fetch.*posts.*post_id"
    - from: "bc-rao-frontend/components/collection/PostFilters.tsx"
      to: "URL search params"
      via: "useSearchParams for shareable filter state"
      pattern: "useSearchParams"
---

<objective>
Build the post browsing UI: card grid layout with archetype badges and scores, three interactive filters (archetype, subreddit, score range), detail modal with full post data, and funnel statistics. Integrate everything into the collection page.

Purpose: This is where users see the value of collection. The browsing experience transforms raw data into actionable intelligence, letting users explore posts by archetype, quality, and source.
Output: Four components (PostGrid, PostFilters, PostDetailModal, FunnelStats) integrated into the collection page with a final checkpoint for user verification.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-collection-pipeline/02-CONTEXT.md
@.planning/phases/02-collection-pipeline/02-RESEARCH.md
@.planning/phases/02-collection-pipeline/02-03-SUMMARY.md
@bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx
@bc-rao-frontend/components/collection/ProgressTracker.tsx
@bc-rao-frontend/components/ui/card.tsx
@bc-rao-frontend/components/ui/dialog.tsx
@bc-rao-frontend/components/ui/select.tsx
@bc-rao-frontend/components/ui/slider.tsx
@bc-rao-frontend/components/ui/badge.tsx
@bc-rao-frontend/components/ui/progress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: PostGrid, PostFilters, PostDetailModal, and FunnelStats components</name>
  <files>
    bc-rao-frontend/components/collection/PostGrid.tsx
    bc-rao-frontend/components/collection/PostFilters.tsx
    bc-rao-frontend/components/collection/PostDetailModal.tsx
    bc-rao-frontend/components/collection/FunnelStats.tsx
  </files>
  <action>
    1. Create `bc-rao-frontend/components/collection/FunnelStats.tsx` (client component):
       - Props: stats ({scraped, filtered, classified, filter_rate, by_archetype: {Journey: N, ProblemSolution: N, Feedback: N}, by_subreddit: {name: count}})
       - Render detailed funnel breakdown per user decision:
         a. Three-step funnel: "{scraped} scraped -> {filtered} passed regex ({filter_rate}% filtered) -> {classified} top posts classified"
         b. Each step as a card/block with count and arrow between them
         c. Expandable section (collapsible via details/summary or state toggle) showing filter reasons breakdown
       - Archetype grouped sections per user decision:
         a. "Journey Posts ({count})" / "Problem-Solution Posts ({count})" / "Feedback Posts ({count})"
         b. Render as horizontal badge/pill group showing distribution

    2. Create `bc-rao-frontend/components/collection/PostFilters.tsx` (client component):
       - Props: subreddits (string[] from campaign), onFiltersChange (callback with filter values)
       - Uses `useSearchParams` and `useRouter` from next/navigation for URL state (shareable filters per research)
       - Three filters per user decision:
         a. Archetype dropdown (Shadcn Select): "All Archetypes", "Journey", "Problem-Solution", "Feedback"
         b. Subreddit dropdown (Shadcn Select): "All Subreddits" + dynamic options from campaign's target_subreddits
         c. Score range slider (Shadcn Slider): range 0-10, default [0, 10], step 0.5
            - Display current range value: "Score: {min} - {max}"
       - On filter change: update URL search params AND call onFiltersChange callback
       - Read initial values from URL params on mount
       - Layout: horizontal flex row, gap-4, responsive (stack vertically on mobile)

    3. Create `bc-rao-frontend/components/collection/PostGrid.tsx` (client component):
       - Props: campaignId (string), filters ({archetype, subreddit, minScore, maxScore}), onPostClick (callback)
       - State: posts array, total count, current page, loading, error
       - Fetch posts from API on mount and when filters change:
         a. Build URL: `/api/campaigns/${campaignId}/posts?page=${page}&per_page=20` (proxy to backend)
            - If creating new proxy route is needed, create `app/api/campaigns/[id]/posts/route.ts` that forwards to FastAPI
            - Or use the backend URL directly if that's the project pattern
         b. Append filter params: archetype, subreddit, minScore, maxScore
         c. Set loading state during fetch
       - Card grid layout per user decision:
         a. `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4` (Claude's discretion: 3 cols on large screens)
         b. Each card using Shadcn Card component:
            - CardHeader: title (line-clamp-2), flex row with Badge for archetype and "r/{subreddit}"
            - CardContent: raw_text snippet (line-clamp-3), bottom row with success score display
            - Success score display (Claude's discretion, research recommends numeric + bar):
              Score as "7.2/10" text next to a small Shadcn Progress bar (width ~80px) showing score percentage
            - cursor-pointer, hover:shadow-lg transition-shadow for click interaction
         c. onClick: call onPostClick with post data
       - Pagination at bottom:
         a. "Showing {start}-{end} of {total}" text
         b. Previous/Next buttons, disabled at boundaries
         c. Simple page-based (no infinite scroll per research recommendation)
       - Empty state: "No posts collected yet. Start a collection to see results here."
       - Loading state: Skeleton cards (3-6 Shadcn Skeleton components in grid layout)

    4. Create `bc-rao-frontend/components/collection/PostDetailModal.tsx` (client component):
       - Props: post (post object or null), open (boolean), onClose (function)
       - Uses Shadcn Dialog component per user decision (post detail opens in modal)
       - Modal content per user decision:
         a. DialogHeader: post title
         b. Badges row: archetype badge (colored), "r/{subreddit}" badge (outline), score badge
         c. Full post text: whitespace-pre-wrap in prose container, scrollable (max-h-[60vh] overflow-y-auto)
         d. Metadata grid (2x2) per user decision:
            - Author: post.author
            - Date: post.reddit_created_at formatted as locale date
            - Upvotes: post.upvote_ratio displayed as percentage or raw value
            - Comments: post.comment_count
         e. Archetype label displayed (no LLM reasoning per user decision)
         f. Success score with progress bar: "{score}/10" with visual bar
       - DialogContent: max-w-3xl, max-h-[80vh] overflow-y-auto
  </action>
  <verify>
    - All 4 component files exist:
      `ls bc-rao-frontend/components/collection/PostGrid.tsx bc-rao-frontend/components/collection/PostFilters.tsx bc-rao-frontend/components/collection/PostDetailModal.tsx bc-rao-frontend/components/collection/FunnelStats.tsx`
    - `npm run build` from bc-rao-frontend compiles without TypeScript errors
  </verify>
  <done>
    Four collection components created: FunnelStats shows scrape/filter/classify pipeline breakdown with archetype distribution. PostFilters provides archetype dropdown, subreddit dropdown, and score range slider with URL state persistence. PostGrid renders Reddit-style card grid with pagination, loading skeletons, and click-to-expand. PostDetailModal shows full post text, metadata, archetype, and success score in accessible dialog.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate browsing components into collection page + navigation updates</name>
  <files>
    bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx
    bc-rao-frontend/components/sidebar/nav-items.ts
  </files>
  <action>
    1. Update `bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx`:
       - Read existing page (from Plan 03) which has idle/collecting/complete phases
       - Add "results" phase after "complete", OR integrate results into "complete" phase
       - Import PostGrid, PostFilters, PostDetailModal, FunnelStats
       - Add state: selectedPost (for modal), filters object
       - After collection complete (or on revisit with existing posts):
         a. Fetch collection stats from `/api/campaigns/${id}/collection-stats` (or proxy route)
         b. Show FunnelStats component with stats data at top
         c. Show PostFilters below funnel stats
         d. Show PostGrid below filters
         e. Show PostDetailModal (controlled by selectedPost state)
       - "Collect More" button per user decision:
         a. Show at top of results view: "Collect More ({N} remaining)"
         b. On click: reset to collecting phase, trigger new collection
         c. Appends new posts (deduplication handled by backend)
         d. Show remaining count (hardcoded for now, e.g., "4 remaining" after first collection on trial)
       - Handle page revisit: If campaign already has collected posts, skip idle phase and show results directly
         a. On mount, check if posts exist for campaign (call collection-stats)
         b. If total > 0: show results view immediately
         c. If total === 0: show idle view with "Start Collection"
       - Create any needed API proxy routes:
         a. `bc-rao-frontend/app/api/campaigns/[id]/posts/route.ts` — GET proxy to FastAPI
         b. `bc-rao-frontend/app/api/campaigns/[id]/collection-stats/route.ts` — GET proxy to FastAPI
         c. Follow existing proxy pattern from app/api/campaigns/route.ts

    2. Update `bc-rao-frontend/components/sidebar/nav-items.ts`:
       - Add "Collection" nav item under Campaigns or as sibling:
         - Label: "Collection" or keep collection accessible only via campaign detail
         - If adding: icon = Database or Archive from lucide-react
       - Actually, collection is per-campaign (not global), so it's better accessed from campaign detail page
       - Instead, add a "Collect Data" action button/link on the campaign detail page at `/dashboard/campaigns/[id]`
       - Read `bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx` and add a "Collect Data" button that links to `/dashboard/campaigns/${id}/collect`
       - This fulfills the user decision: "guided flow after campaign creation"
  </action>
  <verify>
    - Collection page shows results view when posts exist for campaign
    - Collection page shows idle view when no posts exist
    - PostGrid, PostFilters, PostDetailModal, FunnelStats all render on results view
    - "Collect More" button visible in results view
    - Campaign detail page has "Collect Data" link to collection page
    - `npm run build` succeeds with no TypeScript errors
  </verify>
  <done>
    Collection page fully integrated with post browsing: FunnelStats at top, PostFilters below, PostGrid with pagination, PostDetailModal on card click. "Collect More" button appends posts with deduplication. Page detects existing posts on revisit and shows results directly. Campaign detail page links to collection page for guided flow. Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete collection pipeline: Backend (Apify scraping, regex filter, LLM classification, Celery worker, SSE progress) and Frontend (collection trigger page, live progress bar, post browsing grid with filters, detail modal, funnel stats).</what-built>
  <how-to-verify>
    1. Navigate to https://bc-rao-frontend.vercel.app/dashboard/campaigns
    2. Click on an existing campaign (or create one first)
    3. Click "Collect Data" button on campaign detail page
    4. On the collection page, click "Start Collection"
    5. Verify: Live progress bar appears with subreddit-by-subreddit progress
    6. Verify: Funnel stats update in real time (scraped -> filtered -> classified)
    7. Wait for collection to complete
    8. Verify: Results view appears with card grid of collected posts
    9. Verify: Each card shows title, snippet, archetype badge, score bar, subreddit
    10. Try filters: select an archetype, select a subreddit, adjust score slider
    11. Click a post card - verify detail modal opens with full text, metadata, score
    12. Click "Collect More" - verify it triggers new collection without replacing existing posts
    13. Verify the "X remaining" count appears on buttons

    Expected: Full collection flow works end-to-end. If Apify/OpenRouter keys aren't configured, expect errors on collection trigger (this is expected for UAT without credentials).
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Full collection flow: trigger -> progress -> results -> browse -> filter -> detail modal
- Post cards show title, snippet, archetype badge, score (numeric + bar), subreddit
- Three filters work: archetype dropdown, subreddit dropdown, score range slider
- Detail modal shows full post text, author, date, upvotes, comments, archetype, score
- "Collect More" button visible with remaining count, triggers new collection
- Funnel stats show scraped -> filtered -> classified pipeline breakdown
- Archetype sections show counts: "Journey Posts (N)" etc.
- Campaign detail page has "Collect Data" navigation link
- Page revisit shows results if posts exist, idle if no posts
- `npm run build` passes
</verification>

<success_criteria>
- Card grid layout renders collected posts with Reddit-style cards (per user decision)
- Three filters available: archetype dropdown, subreddit dropdown, score range slider (per user decision)
- Post detail opens in modal with full text, metadata, archetype, score (per user decision)
- Archetypes presented as grouped sections with counts (per user decision)
- "Collect More" button appends with dedup, shows remaining count (per user decision)
- Funnel breakdown visible (per user decision)
- No LLM reasoning exposed to user (per user decision)
- Score displayed as numeric + progress bar (Claude's discretion, per research recommendation)
- 3-column grid on large screens, 1-column on mobile (Claude's discretion)
- Pagination with 20 posts per page (per research recommendation)
</success_criteria>

<output>
After completion, create `.planning/phases/02-collection-pipeline/02-04-SUMMARY.md`
</output>

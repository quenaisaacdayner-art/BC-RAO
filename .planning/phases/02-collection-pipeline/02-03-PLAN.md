---
phase: 02-collection-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - bc-rao-frontend/components/ui/progress.tsx
  - bc-rao-frontend/components/ui/dialog.tsx
  - bc-rao-frontend/components/ui/slider.tsx
  - bc-rao-frontend/components/ui/select.tsx
  - bc-rao-frontend/components/ui/badge.tsx
  - bc-rao-frontend/app/api/collection/[taskId]/progress/route.ts
  - bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx
  - bc-rao-frontend/components/collection/ProgressTracker.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to collection page from campaign detail or creation flow"
    - "User can trigger data collection with a single button click"
    - "User sees live progress bar with real-time stats: scraped/filtered/classified counts"
    - "User sees 'Collection in progress, are you sure?' prompt when trying to navigate away"
    - "User sees remaining collection runs count on the trigger button"
    - "Collection page shows current subreddit being processed"
  artifacts:
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx"
      provides: "Collection page with trigger, progress, and navigation guard"
      min_lines: 80
    - path: "bc-rao-frontend/components/collection/ProgressTracker.tsx"
      provides: "Live SSE progress component with funnel stats"
      min_lines: 50
    - path: "bc-rao-frontend/app/api/collection/[taskId]/progress/route.ts"
      provides: "Next.js API route that proxies SSE from FastAPI backend"
      min_lines: 20
  key_links:
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx"
      to: "/api/collection/[taskId]/progress"
      via: "EventSource connection for SSE"
      pattern: "EventSource.*collection.*progress"
    - from: "bc-rao-frontend/app/api/collection/[taskId]/progress/route.ts"
      to: "FastAPI /v1/collection/{task_id}/progress"
      via: "fetch proxy to backend SSE endpoint"
      pattern: "fetch.*collection.*progress"
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx"
      to: "FastAPI POST /v1/collection/campaigns/{id}/collect"
      via: "fetch call to trigger collection"
      pattern: "fetch.*collect"
---

<objective>
Build the collection trigger page with live SSE progress tracking. Users click "Start Collection", see a live progress bar with scraped/filtered/classified counts per subreddit, and get a navigation warning during active collection.

Purpose: This is the primary user interaction point for Phase 2. The guided flow after campaign creation leads here, where users watch their data being collected in real-time.
Output: Collection page at /dashboard/campaigns/[id]/collect with progress tracker, SSE proxy route, and required Shadcn UI components.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-collection-pipeline/02-CONTEXT.md
@.planning/phases/02-collection-pipeline/02-RESEARCH.md
@.planning/phases/02-collection-pipeline/02-02-SUMMARY.md
@bc-rao-frontend/app/dashboard/layout.tsx
@bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx
@bc-rao-frontend/components/sidebar/nav-items.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Shadcn UI components + SSE proxy route</name>
  <files>
    bc-rao-frontend/components/ui/progress.tsx
    bc-rao-frontend/components/ui/dialog.tsx
    bc-rao-frontend/components/ui/slider.tsx
    bc-rao-frontend/components/ui/select.tsx
    bc-rao-frontend/components/ui/badge.tsx
    bc-rao-frontend/app/api/collection/[taskId]/progress/route.ts
  </files>
  <action>
    1. Install missing Shadcn components from bc-rao-frontend directory:
       - `npx shadcn@latest add progress` (for progress bar)
       - `npx shadcn@latest add dialog` (for post detail modal in Plan 04)
       - `npx shadcn@latest add slider` (for score range filter in Plan 04)
       - `npx shadcn@latest add select` (for dropdown filters in Plan 04)
       - `npx shadcn@latest add badge` (for archetype badges)
       - Use `--yes` flag to auto-accept defaults
       - If shadcn CLI is `shadcn-ui` in this project, adjust accordingly (check package.json)

    2. Create SSE proxy route at `bc-rao-frontend/app/api/collection/[taskId]/progress/route.ts`:
       - Export async GET handler
       - Extract taskId from params
       - Determine backend API URL: Use process.env.NEXT_PUBLIC_API_URL or fallback to appropriate base URL (check how existing API routes in app/api/campaigns/route.ts determine the backend URL)
       - Fetch from FastAPI SSE endpoint: `${apiUrl}/v1/collection/${taskId}/progress`
       - Stream the response body through to the client as-is
       - Return new Response with body from backend fetch, headers: Content-Type: text/event-stream, Cache-Control: no-cache, Connection: keep-alive
       - On error: return Response with error event in SSE format
  </action>
  <verify>
    - Verify Shadcn components installed: `ls bc-rao-frontend/components/ui/progress.tsx bc-rao-frontend/components/ui/dialog.tsx bc-rao-frontend/components/ui/slider.tsx bc-rao-frontend/components/ui/select.tsx bc-rao-frontend/components/ui/badge.tsx`
    - Verify SSE proxy route exists: `ls bc-rao-frontend/app/api/collection/[taskId]/progress/route.ts`
    - `npm run build` from bc-rao-frontend (or `npx next build`) compiles without errors related to new components
  </verify>
  <done>
    All 5 Shadcn UI components (progress, dialog, slider, select, badge) installed and importable. SSE proxy route created to stream FastAPI progress events to the browser EventSource. Build succeeds with no import errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Collection page with trigger button and live progress tracker</name>
  <files>
    bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx
    bc-rao-frontend/components/collection/ProgressTracker.tsx
  </files>
  <action>
    1. Create `bc-rao-frontend/components/collection/ProgressTracker.tsx` (client component):
       - Props: taskId (string), onComplete (callback)
       - State: progress object {scraped, filtered, classified, currentStep, totalSteps, currentSubreddit, errors}, isComplete (bool), error (string|null)
       - useEffect with EventSource:
         a. Connect to `/api/collection/${taskId}/progress`
         b. On "message" event: parse JSON data
            - If state === "PROGRESS": update progress state from meta
            - If state === "SUCCESS": set isComplete, call onComplete with result
            - If state includes error: set error state
         c. On "error" event: set error state, close EventSource
         d. Cleanup: return () => eventSource.close() -- CRITICAL to prevent connection leaks
       - Render:
         a. Shadcn Progress component with value = (currentStep / totalSteps) * 100
         b. Current subreddit being processed: "Processing r/{currentSubreddit}..."
         c. Funnel stats line (per user decision): "Scraped {scraped} posts -> {filtered} passed regex -> {classified} classified"
            - Use arrow characters, animated counter transitions
         d. Step counter: "Step {currentStep} of {totalSteps} subreddits"
         e. If errors array has items: yellow warning banner with "Some subreddits had issues" (aggregate per user decision)
         f. If isComplete: green success banner with final stats

    2. Create `bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx` (client component):
       - State: phase ("idle" | "collecting" | "complete"), taskId (string|null), campaignName (string)
       - On mount: fetch campaign details from `/api/campaigns/${id}` to get name and subreddit count
       - Navigation guard: useEffect that adds `beforeunload` event listener when phase === "collecting"
         - Prompt: "Collection in progress, are you sure you want to leave?"
         - Remove listener on cleanup or when phase changes
       - Render based on phase:

         **idle phase:**
         - Page title: "Collect Data" with campaign name subtitle
         - Card explaining what collection does: "We'll scrape your target subreddits, filter for quality posts, and classify the top results into archetypes."
         - "Start Collection" button (primary, large)
           - Show remaining collection runs count: "Start Collection (5 remaining)" per user decision
           - For now, hardcode remaining count display (e.g., "5 remaining" for trial) since billing enforcement is Phase 6
           - On click: POST to `/api/campaigns/${id}` route that proxies to backend `/v1/collection/campaigns/${id}/collect`
             - Or call backend directly if frontend API routes follow the existing pattern (check how campaign API calls work)
           - On success: set taskId from response, set phase to "collecting"
         - Show target subreddits list from campaign data

         **collecting phase:**
         - ProgressTracker component with taskId
         - "Collection in progress..." header
         - Subtle animated indicator (Tailwind animate-pulse on a dot or similar)
         - onComplete callback: transition to "complete" phase

         **complete phase (Claude's discretion: auto-transition to results):**
         - Success message with final funnel stats: "Scraped X -> Y passed regex -> Z classified"
         - "View Results" button linking to the browsing view (to be built in Plan 04)
         - "Collect More (N remaining)" button to restart collection
         - If there were errors (partial failure), show warning: "Failed to collect from: r/xyz, r/abc. You can try again with Collect More."

       - Create the API proxy route if needed: `bc-rao-frontend/app/api/campaigns/[id]/collect/route.ts`
         - POST handler that proxies to FastAPI backend `/v1/collection/campaigns/${campaignId}/collect`
         - Include auth token from cookies/session in the proxy request
         - Return 202 with task_id from backend response
  </action>
  <verify>
    - `ls bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx` exists
    - `ls bc-rao-frontend/components/collection/ProgressTracker.tsx` exists
    - `npm run build` from bc-rao-frontend compiles successfully
    - No TypeScript errors in new files
  </verify>
  <done>
    Collection page renders at /dashboard/campaigns/[id]/collect with three phases (idle/collecting/complete). ProgressTracker connects via EventSource to SSE proxy, displays live progress bar with scraped/filtered/classified funnel stats. Navigation guard warns user during active collection. Trigger button shows remaining collection runs count. Complete phase shows final stats with "View Results" and "Collect More" actions. Partial failure warnings displayed when some subreddits fail.
  </done>
</task>

</tasks>

<verification>
- Navigate to /dashboard/campaigns/[id]/collect and see the idle state with "Start Collection" button
- Progress tracker component renders Shadcn Progress bar
- All Shadcn components (progress, dialog, slider, select, badge) importable
- SSE proxy route correctly proxies backend streaming response
- Browser beforeunload event fires during collection phase
- Build succeeds with zero TypeScript errors
</verification>

<success_criteria>
- Collection page accessible at /dashboard/campaigns/[id]/collect
- "Start Collection" button triggers POST to backend and receives task_id
- ProgressTracker connects to SSE, displays live funnel stats (scraped -> filtered -> classified)
- Navigation guard active during collection (beforeunload prompt)
- Remaining collection runs displayed on button (hardcoded for now)
- Complete phase auto-transitions with final stats and action buttons
- Partial failure warnings shown when subreddits fail
- EventSource properly cleaned up on unmount (no connection leaks)
</success_criteria>

<output>
After completion, create `.planning/phases/02-collection-pipeline/02-03-SUMMARY.md`
</output>

---
phase: 01-foundation-core-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bc-rao-api/app/main.py
  - bc-rao-api/app/config.py
  - bc-rao-api/app/dependencies.py
  - bc-rao-api/app/api/v1/router.py
  - bc-rao-api/app/models/common.py
  - bc-rao-api/app/utils/errors.py
  - bc-rao-api/app/integrations/supabase_client.py
  - bc-rao-api/pyproject.toml
  - bc-rao-api/.env.example
  - migrations/001_initial_schema.sql
autonomous: true

must_haves:
  truths:
    - "FastAPI server starts and responds to /health with 200"
    - "All Phase 1 tables exist in Supabase with RLS enabled and policies created"
    - "API returns standardized error shape on validation errors and 404s"
    - "JWT middleware rejects requests without valid Supabase token"
  artifacts:
    - path: "bc-rao-api/app/main.py"
      provides: "FastAPI app with CORS, health check, v1 router"
      min_lines: 30
    - path: "bc-rao-api/app/config.py"
      provides: "Pydantic BaseSettings for all env vars"
      exports: ["Settings", "settings"]
    - path: "bc-rao-api/app/dependencies.py"
      provides: "JWT validation dependency"
      exports: ["get_current_user"]
    - path: "bc-rao-api/app/utils/errors.py"
      provides: "Standard error shape and error codes"
      exports: ["AppError", "error_handler"]
    - path: "bc-rao-api/app/models/common.py"
      provides: "Shared Pydantic models for error responses"
      exports: ["ErrorResponse", "ErrorDetail"]
    - path: "migrations/001_initial_schema.sql"
      provides: "Full database schema with RLS policies"
      contains: "CREATE TABLE campaigns"
  key_links:
    - from: "bc-rao-api/app/main.py"
      to: "bc-rao-api/app/api/v1/router.py"
      via: "include_router"
      pattern: "app\\.include_router"
    - from: "bc-rao-api/app/main.py"
      to: "bc-rao-api/app/utils/errors.py"
      via: "exception handler registration"
      pattern: "app\\.add_exception_handler|@app\\.exception_handler"
    - from: "bc-rao-api/app/dependencies.py"
      to: "bc-rao-api/app/config.py"
      via: "settings import for JWT secret"
      pattern: "settings\\.SUPABASE_JWT_SECRET"
---

<objective>
Backend foundation: FastAPI scaffold with JWT auth dependency, standardized error handling, Supabase client, and full database schema with RLS.

Purpose: Every subsequent plan (auth endpoints, campaign API, worker infra) depends on this backend scaffold existing with working config, auth middleware, and error handling.
Output: Running FastAPI server, SQL migration file ready for Supabase, shared utilities.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-setup/01-RESEARCH.md
@bc-rao-system-spec_1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema migration with RLS policies</name>
  <files>migrations/001_initial_schema.sql</files>
  <action>
Create the full SQL migration file at project root `migrations/001_initial_schema.sql` containing:

1. Extensions: `uuid-ossp` and `vector` (pgvector)
2. Enum types: `plan_tier`, `subscription_status`, `campaign_status`, `post_archetype`, `draft_status`, `post_lifecycle`, `failure_category`, `usage_action`, `alert_type`
3. Tables (exactly as defined in system spec Section 4):
   - `profiles` (extends auth.users)
   - `subscriptions` (with trial defaults)
   - `campaigns` (with keywords TEXT[], target_subreddits TEXT[])
   - `raw_posts` (with embedding vector(1536))
   - `community_profiles`
   - `generated_drafts`
   - `shadow_table`
   - `syntax_blacklist`
   - `usage_tracking`
   - `email_alerts`
   - `audit_log`
4. All indexes from system spec
5. RLS enabled on ALL tenant-scoped tables
6. RLS policies for each table using `auth.uid()` (NEVER user_metadata):
   - SELECT: `auth.uid() = user_id`
   - INSERT: `auth.uid() = user_id` (WITH CHECK)
   - UPDATE: `auth.uid() = user_id` (USING + WITH CHECK)
   - DELETE: `auth.uid() = user_id`
   - For profiles: use `auth.uid() = id` (since id IS the user id)
7. Add a Supabase trigger function for auto-creating profile on signup:
   ```sql
   CREATE OR REPLACE FUNCTION handle_new_user()
   RETURNS TRIGGER AS $$
   BEGIN
     INSERT INTO profiles (id, full_name)
     VALUES (NEW.id, NEW.raw_user_meta_data->>'full_name');
     INSERT INTO subscriptions (user_id) VALUES (NEW.id);
     RETURN NEW;
   END;
   $$ LANGUAGE plpgsql SECURITY DEFINER;

   CREATE TRIGGER on_auth_user_created
     AFTER INSERT ON auth.users
     FOR EACH ROW EXECUTE FUNCTION handle_new_user();
   ```

This trigger handles AUTH-04 (profile auto-created on signup with subscription).

Note: This migration file is meant to be run in Supabase SQL Editor. Include a comment header explaining this.
  </action>
  <verify>Review SQL syntax: all CREATE TABLE, CREATE INDEX, ALTER TABLE ENABLE ROW LEVEL SECURITY, and CREATE POLICY statements present. Count: 11 tables, RLS on 9 tenant-scoped tables, 4 policies per table (SELECT, INSERT, UPDATE, DELETE).</verify>
  <done>Complete SQL migration file with all Phase 1+ tables, indexes, RLS enabled, policies using auth.uid(), and profile auto-creation trigger.</done>
</task>

<task type="auto">
  <name>Task 2: FastAPI scaffold with config, auth dependency, and error handling</name>
  <files>
    bc-rao-api/pyproject.toml
    bc-rao-api/.env.example
    bc-rao-api/app/__init__.py
    bc-rao-api/app/main.py
    bc-rao-api/app/config.py
    bc-rao-api/app/dependencies.py
    bc-rao-api/app/api/__init__.py
    bc-rao-api/app/api/v1/__init__.py
    bc-rao-api/app/api/v1/router.py
    bc-rao-api/app/models/__init__.py
    bc-rao-api/app/models/common.py
    bc-rao-api/app/services/__init__.py
    bc-rao-api/app/utils/__init__.py
    bc-rao-api/app/utils/errors.py
    bc-rao-api/app/utils/security.py
    bc-rao-api/app/integrations/__init__.py
    bc-rao-api/app/integrations/supabase_client.py
  </files>
  <action>
Create the complete FastAPI backend scaffold following system spec Section 12 structure:

**pyproject.toml:**
- Python 3.11+ requirement
- Dependencies: fastapi[standard], uvicorn[standard], pydantic, pydantic-settings, python-jose[cryptography], httpx, supabase (Python SDK)
- Dev dependencies: pytest, pytest-asyncio, httpx (for test client)
- Script entry: `uvicorn app.main:app --reload`

**.env.example:**
- All env vars from system spec Section 10.1: SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY, SUPABASE_JWT_SECRET, REDIS_URL, CELERY_BROKER_URL, CELERY_RESULT_BACKEND, OPENROUTER_API_KEY, APP_ENV, CORS_ORIGINS
- Include placeholder values with comments

**app/config.py:**
- Pydantic BaseSettings class with all env vars
- Use `env_file = ".env"`, `case_sensitive = True`
- `@lru_cache()` wrapped `get_settings()` function
- Export `settings` instance

**app/dependencies.py:**
- `get_current_user` dependency using HTTPBearer + python-jose
- Decode JWT with HS256, verify against SUPABASE_JWT_SECRET
- On failure: raise HTTPException 401 with error code AUTH_INVALID
- Return decoded payload dict (contains `sub` as user_id)

**app/utils/errors.py:**
- Define `AppError` exception class with: code (str), message (str), details (dict), status_code (int)
- Error codes enum/constants matching system spec Section 9.1: AUTH_REQUIRED, AUTH_INVALID, PLAN_LIMIT_REACHED, RATE_LIMITED, RESOURCE_NOT_FOUND, VALIDATION_ERROR, COLLECTION_IN_PROGRESS, INFERENCE_FAILED, APIFY_ERROR, STRIPE_ERROR, INTERNAL_ERROR
- Register exception handlers on FastAPI app:
  - `AppError` -> `{"error": {"code": ..., "message": ..., "details": ...}}`
  - `RequestValidationError` -> `{"error": {"code": "VALIDATION_ERROR", "message": ..., "details": ...}}`
  - Generic `Exception` -> `{"error": {"code": "INTERNAL_ERROR", "message": "An unexpected error occurred"}}`

**app/models/common.py:**
- `ErrorDetail` Pydantic model: code (str), message (str), details (dict | None)
- `ErrorResponse` Pydantic model: error (ErrorDetail)
- Used for OpenAPI documentation on error responses

**app/utils/security.py:**
- Placeholder module for future security utilities
- Export `verify_jwt` function (extracted from dependencies for testability)

**app/integrations/supabase_client.py:**
- Create Supabase client using service role key (for server-side operations)
- `get_supabase_client()` function returning Client instance
- Use lazy initialization pattern

**app/api/v1/router.py:**
- Create main v1 APIRouter
- Import and include auth and campaigns sub-routers (placeholder imports, actual routers created in later plans)
- For now, include only health-related or placeholder routes

**app/main.py:**
- Create FastAPI app with title "BC-RAO API", version "1.0.0"
- Conditional docs_url (None in production)
- Add CORSMiddleware with settings.CORS_ORIGINS
- Register error handlers from utils/errors.py
- Include v1 router under `/v1` prefix
- Add `/health` endpoint returning `{"status": "healthy"}`

All `__init__.py` files should be empty (or minimal re-exports where useful).
  </action>
  <verify>
From bc-rao-api directory:
1. `pip install -e .` or `pip install -r requirements.txt` succeeds
2. `python -c "from app.main import app; print(app.title)"` prints "BC-RAO API"
3. `python -c "from app.dependencies import get_current_user; print('OK')"` prints OK
4. `python -c "from app.utils.errors import AppError; print(AppError.__name__)"` prints AppError
  </verify>
  <done>FastAPI app starts, /health returns 200, JWT dependency importable, error handlers registered, Supabase client configured, all __init__.py files in place for the module structure.</done>
</task>

</tasks>

<verification>
1. `cd bc-rao-api && uvicorn app.main:app --port 8000` starts without errors
2. `curl http://localhost:8000/health` returns `{"status": "healthy"}`
3. `curl http://localhost:8000/v1/nonexistent` returns standardized error shape
4. SQL migration file contains all 11 tables and RLS policies
5. `.env.example` has all required environment variables listed
</verification>

<success_criteria>
- FastAPI server starts and responds to health check
- JWT auth dependency correctly rejects missing/invalid tokens
- Error responses follow `{"error": {"code", "message", "details"}}` shape
- SQL migration is complete with all tables, indexes, RLS, and profile trigger
- Backend project structure matches system spec Section 12
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-setup/01-01-SUMMARY.md`
</output>

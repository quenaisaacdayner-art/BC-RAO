---
phase: 01-foundation-core-setup
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - bc-rao-api/app/api/v1/auth.py
  - bc-rao-api/app/models/auth.py
  - bc-rao-api/app/services/auth_service.py
  - bc-rao-api/app/api/v1/router.py
  - bc-rao-frontend/app/(auth)/login/page.tsx
  - bc-rao-frontend/app/(auth)/signup/page.tsx
  - bc-rao-frontend/app/(auth)/layout.tsx
  - bc-rao-frontend/lib/api.ts
  - bc-rao-frontend/components/forms/login-form.tsx
  - bc-rao-frontend/components/forms/signup-form.tsx
autonomous: true

must_haves:
  truths:
    - "User can sign up with email and password and is redirected to dashboard"
    - "User can log in with existing credentials and JWT persists across browser refresh"
    - "User can log out from any page and is redirected to login"
    - "Profile and trial subscription are auto-created on signup"
    - "Invalid credentials show clear error message"
  artifacts:
    - path: "bc-rao-api/app/api/v1/auth.py"
      provides: "Auth endpoints: signup, login, refresh, me, logout"
      exports: ["router"]
    - path: "bc-rao-api/app/models/auth.py"
      provides: "Auth Pydantic models"
      exports: ["SignupRequest", "LoginRequest", "AuthResponse"]
    - path: "bc-rao-api/app/services/auth_service.py"
      provides: "Auth service calling Supabase Auth"
      exports: ["AuthService"]
    - path: "bc-rao-frontend/app/(auth)/login/page.tsx"
      provides: "Login page with email/password form"
      min_lines: 20
    - path: "bc-rao-frontend/app/(auth)/signup/page.tsx"
      provides: "Signup page with email/password/name form"
      min_lines: 20
  key_links:
    - from: "bc-rao-frontend/components/forms/login-form.tsx"
      to: "bc-rao-frontend/lib/supabase/client.ts"
      via: "Supabase signInWithPassword"
      pattern: "signInWithPassword"
    - from: "bc-rao-api/app/api/v1/auth.py"
      to: "bc-rao-api/app/services/auth_service.py"
      via: "service method calls"
      pattern: "auth_service\\."
    - from: "bc-rao-api/app/services/auth_service.py"
      to: "bc-rao-api/app/integrations/supabase_client.py"
      via: "Supabase admin client for signup"
      pattern: "supabase\\.auth\\.admin"
---

<objective>
Complete auth system: Backend auth endpoints (signup, login, refresh, me) + frontend auth pages (login, signup) with Supabase Auth integration.

Purpose: Every protected feature needs auth working. Users must be able to sign up, log in, and have their profile + trial subscription auto-created.
Output: Working signup/login flow, JWT persistence, profile auto-creation via DB trigger.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-setup/01-RESEARCH.md
@.planning/phases/01-foundation-core-setup/01-01-SUMMARY.md
@.planning/phases/01-foundation-core-setup/01-02-SUMMARY.md
@bc-rao-system-spec_1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth backend — endpoints, models, and service</name>
  <files>
    bc-rao-api/app/models/auth.py
    bc-rao-api/app/services/auth_service.py
    bc-rao-api/app/api/v1/auth.py
    bc-rao-api/app/api/v1/router.py
  </files>
  <action>
**app/models/auth.py:**
- `SignupRequest`: email (EmailStr), password (str, min 6), full_name (str)
- `LoginRequest`: email (EmailStr), password (str)
- `RefreshRequest`: refresh_token (str)
- `AuthResponse`: user_id (str), access_token (str), refresh_token (str)
- `LoginResponse`: access_token (str), refresh_token (str), user (dict)
- `UserProfile`: id (str), full_name (str | None), email (str), plan (str), trial_ends_at (str | None), onboarding_completed (bool)

**app/services/auth_service.py:**
- `AuthService` class using Supabase client from integrations
- `signup(email, password, full_name)`:
  - Call `supabase.auth.sign_up({"email": email, "password": password, "options": {"data": {"full_name": full_name}}})`
  - The DB trigger (from Plan 01 migration) handles profile + subscription creation
  - Return user_id, access_token, refresh_token
  - On error: raise AppError with AUTH_INVALID
- `login(email, password)`:
  - Call `supabase.auth.sign_in_with_password({"email": email, "password": password})`
  - Return tokens + user info
- `refresh(refresh_token)`:
  - Call `supabase.auth.refresh_session(refresh_token)`
  - Return new token pair
- `get_me(user_id)`:
  - Query profiles table for user profile
  - Query subscriptions table for plan info
  - Return combined UserProfile data

**app/api/v1/auth.py:**
- POST `/auth/signup` -> AuthService.signup -> 201 AuthResponse
- POST `/auth/login` -> AuthService.login -> 200 LoginResponse
- POST `/auth/refresh` -> AuthService.refresh -> 200 AuthResponse
- GET `/auth/me` (protected, requires get_current_user) -> AuthService.get_me -> 200 UserProfile
- All errors use AppError with proper error codes

**app/api/v1/router.py:**
- Update to include auth router: `router.include_router(auth_router)`
  </action>
  <verify>
1. Start server: `uvicorn app.main:app --reload`
2. Check OpenAPI docs at http://localhost:8000/docs — auth endpoints listed
3. `curl -X POST http://localhost:8000/v1/auth/signup -H "Content-Type: application/json" -d '{"email":"test@test.com","password":"test123","full_name":"Test"}' ` returns token response or Supabase error
  </verify>
  <done>Auth endpoints return proper responses, signup creates user in Supabase Auth (profile + subscription via trigger), login returns JWT tokens, /me returns user profile with plan info.</done>
</task>

<task type="auto">
  <name>Task 2: Auth frontend — login, signup pages with Supabase client</name>
  <files>
    bc-rao-frontend/app/(auth)/layout.tsx
    bc-rao-frontend/app/(auth)/login/page.tsx
    bc-rao-frontend/app/(auth)/signup/page.tsx
    bc-rao-frontend/components/forms/login-form.tsx
    bc-rao-frontend/components/forms/signup-form.tsx
    bc-rao-frontend/lib/api.ts
  </files>
  <action>
**lib/api.ts:**
- Create API client helper for backend calls
- Base URL from NEXT_PUBLIC_API_URL env var
- `apiClient.post(path, body, token?)` and `apiClient.get(path, token?)` helpers
- Handles error response parsing (extract error.code and error.message)
- Returns typed responses

**app/(auth)/layout.tsx:**
- Centered layout for auth pages
- Clean, minimal design — centered card with BC-RAO branding
- No sidebar (auth pages are outside dashboard)

**components/forms/signup-form.tsx:**
- "use client" component
- React Hook Form + Zod validation:
  - full_name: required string
  - email: valid email
  - password: min 6 chars
- Uses Shadcn Form, Input, Button, Label components
- On submit: call Supabase client `supabase.auth.signUp()` directly (client-side auth)
  - Pass `full_name` in `options.data` for the DB trigger
- On success: redirect to /dashboard using `router.push`
- On error: show error message via inline form error (not toast — per auth forms convention)
- Loading state on submit button
- Link to "Already have an account? Log in"

**components/forms/login-form.tsx:**
- "use client" component
- React Hook Form + Zod validation:
  - email: valid email
  - password: required
- On submit: call Supabase client `supabase.auth.signInWithPassword()`
- On success: redirect to /dashboard
- On error: show "Invalid email or password" inline
- Loading state on submit button
- Link to "Don't have an account? Sign up"

**app/(auth)/login/page.tsx:**
- Server component page wrapper
- Renders LoginForm inside auth layout card
- Title: "Welcome back" or similar professional tone

**app/(auth)/signup/page.tsx:**
- Server component page wrapper
- Renders SignupForm inside auth layout card
- Title: "Create your account"

**Important architectural note:** Auth is handled client-side via Supabase JS client (signUp, signInWithPassword). The backend auth endpoints exist for programmatic access and the /me endpoint. The frontend uses Supabase client directly for auth operations — this is the standard Supabase + Next.js pattern. The Supabase middleware handles token refresh automatically.

**Logout:** Add a `signOut` function to the Supabase client usage. Actual logout button will be added in Plan 05/06 (dashboard sidebar user menu). For now, ensure the signOut helper is exported from a shared location.
  </action>
  <verify>
1. `npm run build` succeeds
2. Visit http://localhost:3000/login — login form renders with email/password fields
3. Visit http://localhost:3000/signup — signup form renders with name/email/password fields
4. Form validation works: submit empty form shows errors
5. No hydration warnings in console
  </verify>
  <done>Login and signup pages render with validated forms, Supabase client handles auth operations, successful auth redirects to /dashboard, errors shown inline.</done>
</task>

</tasks>

<verification>
1. Full signup flow: visit /signup, fill form, submit -> user created in Supabase, profile + subscription in DB, redirect to /dashboard
2. Full login flow: visit /login, use signup credentials, submit -> JWT stored, redirect to /dashboard
3. JWT persistence: refresh browser on /dashboard -> still authenticated (middleware refreshes token)
4. Invalid credentials: wrong password on /login -> error message shown
5. GET /v1/auth/me with valid JWT -> returns user profile with plan info
</verification>

<success_criteria>
- AUTH-01: User can sign up with email and password via Supabase Auth
- AUTH-02: User can log in and receive JWT that persists across browser refresh
- AUTH-03: Logout helper available (button added in dashboard plan)
- AUTH-04: Profile and subscription created automatically on signup via DB trigger
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-setup/01-03-SUMMARY.md`
</output>

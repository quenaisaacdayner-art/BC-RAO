---
phase: 01-foundation-core-setup
plan: 05
type: execute
wave: 3
depends_on: ["01-01", "01-03"]
files_modified:
  - bc-rao-api/app/models/campaign.py
  - bc-rao-api/app/services/campaign_service.py
  - bc-rao-api/app/api/v1/campaigns.py
  - bc-rao-api/app/api/v1/router.py
  - bc-rao-frontend/app/(dashboard)/layout.tsx
  - bc-rao-frontend/app/(dashboard)/page.tsx
  - bc-rao-frontend/components/sidebar/app-sidebar.tsx
  - bc-rao-frontend/components/sidebar/nav-items.ts
autonomous: true

must_haves:
  truths:
    - "Campaign CRUD API accepts authenticated requests and returns proper responses"
    - "Dashboard layout has collapsible sidebar with icon-only mode"
    - "Overview page shows campaign count or hides stats when no data exists"
    - "User can log out from sidebar user menu"
    - "Dark/light mode toggle works from sidebar"
  artifacts:
    - path: "bc-rao-api/app/api/v1/campaigns.py"
      provides: "Campaign CRUD endpoints"
      exports: ["router"]
    - path: "bc-rao-api/app/models/campaign.py"
      provides: "Campaign Pydantic models with validation"
      exports: ["CampaignCreate", "CampaignUpdate", "CampaignResponse"]
    - path: "bc-rao-api/app/services/campaign_service.py"
      provides: "Campaign service with Supabase queries"
      exports: ["CampaignService"]
    - path: "bc-rao-frontend/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with SidebarProvider"
      contains: "SidebarProvider"
    - path: "bc-rao-frontend/components/sidebar/app-sidebar.tsx"
      provides: "Collapsible sidebar with navigation and user menu"
      contains: "collapsible"
  key_links:
    - from: "bc-rao-api/app/api/v1/campaigns.py"
      to: "bc-rao-api/app/services/campaign_service.py"
      via: "service dependency injection"
      pattern: "campaign_service\\."
    - from: "bc-rao-api/app/api/v1/campaigns.py"
      to: "bc-rao-api/app/dependencies.py"
      via: "JWT auth dependency"
      pattern: "Depends\\(get_current_user\\)"
    - from: "bc-rao-frontend/app/(dashboard)/layout.tsx"
      to: "bc-rao-frontend/components/sidebar/app-sidebar.tsx"
      via: "Sidebar component rendering"
      pattern: "<AppSidebar"
    - from: "bc-rao-frontend/components/sidebar/app-sidebar.tsx"
      to: "bc-rao-frontend/lib/supabase/client.ts"
      via: "signOut for logout"
      pattern: "signOut"
---

<objective>
Campaign API backend + dashboard shell: Full campaign CRUD endpoints with validation, plus the dashboard layout with collapsible sidebar, overview page, and user menu.

Purpose: Campaign management is the core user interaction for Phase 1. The dashboard shell provides the navigation framework for all subsequent UI plans.
Output: Working campaign API, dashboard layout with sidebar, overview page with empty state handling.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-setup/01-RESEARCH.md
@.planning/phases/01-foundation-core-setup/01-01-SUMMARY.md
@.planning/phases/01-foundation-core-setup/01-02-SUMMARY.md
@.planning/phases/01-foundation-core-setup/01-03-SUMMARY.md
@bc-rao-system-spec_1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Campaign CRUD API — models, service, endpoints</name>
  <files>
    bc-rao-api/app/models/campaign.py
    bc-rao-api/app/services/campaign_service.py
    bc-rao-api/app/api/v1/campaigns.py
    bc-rao-api/app/api/v1/router.py
  </files>
  <action>
**app/models/campaign.py:**
- `CampaignCreate` (request model):
  - name: str (min 1, max 100)
  - description: str | None = None
  - product_context: str (min 10)
  - product_url: str | None = None (validate as URL if provided)
  - keywords: list[str] (validated: min 5, max 15 items, use a validator that accepts comma-separated string OR list)
  - target_subreddits: list[str] (min 1, max based on plan — enforce in service, not model)
- `CampaignUpdate` (request model):
  - name: str | None = None
  - description: str | None = None
  - product_context: str | None = None
  - product_url: str | None = None
  - keywords: list[str] | None = None (same 5-15 validation if provided)
  - target_subreddits: list[str] | None = None
  - status: Literal["active", "paused", "archived"] | None = None
- `CampaignResponse` (response model):
  - id: str
  - name, description, product_context, product_url: str | None
  - keywords: list[str]
  - target_subreddits: list[str]
  - status: str
  - created_at, updated_at: str (ISO format)
- `CampaignWithStats` (response model, extends CampaignResponse):
  - stats: dict with posts_collected (int), drafts_generated (int), active_monitors (int) — all default 0
- `CampaignListResponse`:
  - campaigns: list[CampaignResponse]
  - total: int

**app/services/campaign_service.py:**
- `CampaignService` class using Supabase client
- `create(data: CampaignCreate, user_id: str) -> CampaignResponse`:
  - Insert into campaigns table with user_id
  - Return created campaign
- `list_for_user(user_id: str) -> CampaignListResponse`:
  - Query campaigns where user_id matches, ordered by created_at DESC
  - Return list with total count
- `get_by_id(campaign_id: str, user_id: str) -> CampaignWithStats`:
  - Query campaign by id
  - If not found or wrong user: raise AppError(RESOURCE_NOT_FOUND)
  - Query stats: COUNT from raw_posts, generated_drafts, shadow_table for this campaign
  - Return campaign with stats
- `update(campaign_id: str, data: CampaignUpdate, user_id: str) -> CampaignResponse`:
  - Update only provided fields (exclude None values)
  - If not found: raise AppError(RESOURCE_NOT_FOUND)
  - Return updated campaign
- `delete(campaign_id: str, user_id: str) -> None`:
  - Delete campaign (CASCADE handles related data)
  - If not found: raise AppError(RESOURCE_NOT_FOUND)

**app/api/v1/campaigns.py:**
- Router with prefix `/campaigns`, tags=["campaigns"]
- All endpoints require `user: dict = Depends(get_current_user)`
- POST `/` -> create -> 201
- GET `/` -> list -> 200
- GET `/{campaign_id}` -> get_by_id -> 200
- PATCH `/{campaign_id}` -> update -> 200
- DELETE `/{campaign_id}` -> delete -> 204
- Use `async def` for all handlers (database I/O)

**app/api/v1/router.py:**
- Add campaigns router: `router.include_router(campaigns_router)`
  </action>
  <verify>
1. Server starts with campaign endpoints visible in /docs
2. `curl -X POST http://localhost:8000/v1/campaigns -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" -d '{"name":"Test Campaign","product_context":"A SaaS tool for...","keywords":["saas","startup","growth","marketing","tools"],"target_subreddits":["SaaS"]}'` returns 201
3. `curl http://localhost:8000/v1/campaigns -H "Authorization: Bearer $TOKEN"` returns campaign list
4. Validation error on less than 5 keywords returns standard error shape
  </verify>
  <done>Campaign CRUD API works: create with validation (5-15 keywords), list, get with stats, update, delete with cascade. All endpoints authenticated via JWT.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard shell — sidebar, layout, overview page</name>
  <files>
    bc-rao-frontend/app/(dashboard)/layout.tsx
    bc-rao-frontend/app/(dashboard)/page.tsx
    bc-rao-frontend/components/sidebar/app-sidebar.tsx
    bc-rao-frontend/components/sidebar/nav-items.ts
  </files>
  <action>
**Per user locked decisions:**
- Collapsible left sidebar with icons + labels (collapses to icon-only)
- Main landing page is overview with summary stats
- Balanced info density, Vercel dashboard style
- Dark/light mode toggle from the start
- Overview hides stats until real data exists
- Professional, direct tone

**components/sidebar/nav-items.ts:**
- Define navigation items array:
  - Overview (LayoutDashboard icon) -> /dashboard
  - Campaigns (Target icon) -> /dashboard/campaigns
  - (Placeholder sections for future phases, commented out):
    - Collection (Database icon)
    - Community Profiles (BarChart3 icon)
    - Draft Studio (PenTool icon)
    - Monitoring (Shield icon)
- Export typed nav items array

**components/sidebar/app-sidebar.tsx:**
- "use client" component using Shadcn Sidebar components
- Uses `<Sidebar collapsible="icon">` per user decision (collapses to icon-only)
- SidebarHeader: BC-RAO logo/text (use text "BC-RAO" with a simple icon, not an image)
- SidebarContent: Map over nav-items, render SidebarMenuItem for each
  - Use `SidebarMenuButton` with `asChild` wrapping Next.js `Link`
  - Active state based on current pathname (use `usePathname()`)
  - Each item shows icon + label (label hidden in collapsed state via Shadcn built-in behavior)
- SidebarFooter:
  - Dark/light mode toggle using a button with Sun/Moon icon
    - On click: toggle theme via `useTheme()` from next-themes
  - User menu: DropdownMenu with avatar/name showing:
    - User email (from Supabase session)
    - "Log out" option that:
      1. Calls `supabase.auth.signOut()` from the browser Supabase client (imported from lib/supabase/client.ts)
      2. Then calls `router.push('/login')` to redirect to login page
      3. Implementation: `const supabase = createClient(); await supabase.auth.signOut(); router.push('/login');`
  - Use SidebarMenuButton for the user trigger
- SidebarTrigger: Rendered in the main content area header for mobile/toggle

**app/(dashboard)/layout.tsx:**
- Server component that checks auth (redirect to /login if unauthenticated)
- Wraps children with SidebarProvider
- Layout structure:
  ```
  <SidebarProvider>
    <div className="flex h-screen w-full">
      <AppSidebar />
      <main className="flex-1 overflow-auto">
        <header with SidebarTrigger and page breadcrumb area>
        {children}
      </main>
    </div>
  </SidebarProvider>
  ```

**app/(dashboard)/page.tsx:**
- Overview page (dashboard home)
- Fetch campaign count from API (or Supabase directly via server client)
- **If zero campaigns (empty state per user decision):**
  - Hide stats sections entirely (no skeleton/placeholder metrics)
  - Show a quick-start card:
    - Professional heading: "Get started with BC-RAO"
    - Body: "Create a campaign to start collecting community data."
    - CTA button: "Create your first campaign" -> links to /dashboard/campaigns/new
  - No emoji, no fluff (per user decision)
- **If campaigns exist:**
  - Summary cards (using Shadcn Card):
    - Total Campaigns (count)
    - Recent Activity (last campaign name + date, or "No recent activity")
    - Quick Actions card with "New Campaign" button
  - Campaign cards are balanced, not overwhelming (Vercel dashboard style)
  - Layout: responsive grid, 1 col on mobile, 2-3 cols on desktop
  </action>
  <verify>
1. `npm run build` succeeds
2. Visit /dashboard — sidebar renders with Overview and Campaigns links
3. Sidebar collapses to icon-only when toggle clicked
4. Dark/light mode toggle changes theme
5. User menu shows email and logout option
6. Overview shows empty state card when no campaigns exist
7. No hydration errors in console
  </verify>
  <done>Dashboard shell with collapsible sidebar (icon-only mode), dark/light toggle, user menu with logout (calls supabase.auth.signOut() and redirects to /login), overview page with conditional empty state, professional tone throughout.</done>
</task>

</tasks>

<verification>
1. Campaign API: POST creates campaign, GET lists, PATCH updates, DELETE removes (with 204)
2. Keyword validation: fewer than 5 returns VALIDATION_ERROR
3. Dashboard loads with sidebar, overview page renders
4. Sidebar collapses to icon-only mode
5. Dark mode toggle works and persists
6. Logout from sidebar user menu redirects to /login
7. Empty state shows "Create a campaign to start collecting community data."
</verification>

<success_criteria>
- CAMP-01 (backend): Campaign creation with all fields and validation
- CAMP-02 (backend): Campaign list with stats (zeros for new campaigns)
- CAMP-03 (backend): Campaign update endpoint
- CAMP-04 (backend): Campaign delete with cascade
- AUTH-03 (frontend): Logout button in sidebar user menu calls signOut() and redirects
- Dashboard shell: Collapsible sidebar, dark/light mode, overview with empty state
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-setup/01-05-SUMMARY.md`
</output>

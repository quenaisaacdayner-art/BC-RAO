---
phase: 03-pattern-engine
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - bc-rao-frontend/app/dashboard/campaigns/[id]/analysis/page.tsx
  - bc-rao-frontend/components/analysis/PostScoreBreakdown.tsx
  - bc-rao-frontend/components/analysis/PenaltyHighlighter.tsx
  - bc-rao-frontend/app/dashboard/campaigns/[id]/blacklist/page.tsx
  - bc-rao-frontend/components/analysis/BlacklistTable.tsx
  - bc-rao-frontend/app/api/campaigns/[id]/analyzed-posts/route.ts
  - bc-rao-frontend/app/api/campaigns/[id]/scoring-breakdown/route.ts
  - bc-rao-frontend/app/api/campaigns/[id]/forbidden-patterns/route.ts
autonomous: true

must_haves:
  truths:
    - "User can view dedicated Analysis page with posts sorted/filtered by scoring factors"
    - "User can expand individual post to see 3-4 key scoring factors (rhythm, vulnerability, formality, penalties)"
    - "Penalties highlighted inline in post text with red/orange color coding like a linter"
    - "User can view dedicated Blacklist page showing forbidden patterns across all subreddits"
    - "Blacklist page filterable by subreddit, showing pattern categories with counts"
    - "User can add custom forbidden patterns but cannot remove system-detected ones"
  artifacts:
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/analysis/page.tsx"
      provides: "Dedicated analysis page with post list, sorting, filtering, expandable breakdowns"
      min_lines: 80
    - path: "bc-rao-frontend/components/analysis/PostScoreBreakdown.tsx"
      provides: "Expandable scoring breakdown showing 3-4 key factors per post"
      min_lines: 50
    - path: "bc-rao-frontend/components/analysis/PenaltyHighlighter.tsx"
      provides: "Inline text highlighting for penalties using react-highlight-words"
      min_lines: 30
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/blacklist/page.tsx"
      provides: "Dedicated blacklist page with pattern categories and custom pattern form"
      min_lines: 60
    - path: "bc-rao-frontend/components/analysis/BlacklistTable.tsx"
      provides: "Forbidden patterns table grouped by category with counts"
      min_lines: 40
  key_links:
    - from: "bc-rao-frontend/components/analysis/PenaltyHighlighter.tsx"
      to: "react-highlight-words"
      via: "Highlighter component for inline marking"
      pattern: "from.*react-highlight-words.*import"
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/analysis/page.tsx"
      to: "/api/campaigns/[id]/analyzed-posts"
      via: "fetch for post list with scores"
      pattern: "fetch.*analyzed-posts"
    - from: "bc-rao-frontend/components/analysis/PostScoreBreakdown.tsx"
      to: "/api/campaigns/[id]/scoring-breakdown"
      via: "fetch on expand for detailed breakdown"
      pattern: "fetch.*scoring-breakdown"
---

<objective>
Build the dedicated Analysis page for viewing posts with scoring breakdowns and inline penalty highlighting, plus the Blacklist page for managing forbidden patterns across subreddits.

Purpose: Users need to understand WHY posts scored the way they did — which factors contributed, which phrases were penalized. The analysis page is separate from Phase 2's browsing (LOCKED decision). The blacklist page surfaces forbidden pattern intelligence and allows custom pattern additions.

Output: Analysis page with expandable post breakdowns, penalty highlighter, and blacklist management page.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pattern-engine/03-RESEARCH.md
@.planning/phases/03-pattern-engine/03-CONTEXT.md
@.planning/phases/03-pattern-engine/03-02-SUMMARY.md
@bc-rao-frontend/lib/api.ts
@bc-rao-frontend/components/collection/PostGrid.tsx
@bc-rao-frontend/components/collection/PostFilters.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-highlight-words + API proxy routes + PenaltyHighlighter + PostScoreBreakdown</name>
  <files>
    bc-rao-frontend/app/api/campaigns/[id]/analyzed-posts/route.ts
    bc-rao-frontend/app/api/campaigns/[id]/scoring-breakdown/route.ts
    bc-rao-frontend/app/api/campaigns/[id]/forbidden-patterns/route.ts
    bc-rao-frontend/components/analysis/PenaltyHighlighter.tsx
    bc-rao-frontend/components/analysis/PostScoreBreakdown.tsx
  </files>
  <action>
    **Install react-highlight-words:**
    ```bash
    cd bc-rao-frontend && npm install react-highlight-words
    npm install -D @types/react-highlight-words
    ```
    Note: Check if @types package exists. If not, create a local declaration file `bc-rao-frontend/types/react-highlight-words.d.ts` with `declare module 'react-highlight-words'`.

    **Create API proxy routes:**

    `bc-rao-frontend/app/api/campaigns/[id]/analyzed-posts/route.ts`:
    Proxy GET to FastAPI `GET /v1/analysis/campaigns/{id}/analyzed-posts`.
    Pass through query params: subreddit, sort_by, sort_dir, page, per_page.

    `bc-rao-frontend/app/api/campaigns/[id]/scoring-breakdown/route.ts`:
    Proxy GET to FastAPI `GET /v1/analysis/campaigns/{id}/scoring-breakdown?post_id={post_id}`.
    Pass through post_id query param.

    `bc-rao-frontend/app/api/campaigns/[id]/forbidden-patterns/route.ts`:
    Proxy GET and POST to FastAPI:
    - GET: `/v1/analysis/campaigns/{id}/forbidden-patterns?subreddit={subreddit}`
    - POST: `/v1/analysis/campaigns/{id}/forbidden-patterns` with body `{category, pattern, subreddit?}`

    **Create `bc-rao-frontend/components/analysis/PenaltyHighlighter.tsx`:**
    "use client" component per LOCKED decision (penalties highlighted inline like a linter).

    Props: `{ text: string, penalties: { phrase: string, severity: 'high' | 'medium' | 'low', category: string }[] }`

    Implementation:
    - Import Highlighter from 'react-highlight-words'
    - Map penalties to searchWords array
    - Use `findChunks` prop or `highlightClassName` to apply severity-based styling:
      - high: `bg-red-100 text-red-900 border-b-2 border-red-500 rounded-sm px-0.5`
      - medium: `bg-orange-100 text-orange-900 border-b-2 border-orange-500 rounded-sm px-0.5`
      - low: `bg-yellow-100 text-yellow-900 border-b-2 border-yellow-500 rounded-sm px-0.5`
    - Use `autoEscape={true}` to handle regex special chars in phrases
    - Show tooltip on hover over highlighted phrase showing category name (use shadcn Tooltip)
    - If no penalties: render text as plain paragraph

    **Create `bc-rao-frontend/components/analysis/PostScoreBreakdown.tsx`:**
    "use client" component. Expandable breakdown per LOCKED decision (3-4 key factors).

    Props: `{ postId: string, campaignId: string, postText: string, totalScore: number }`

    States: collapsed (default) / expanded

    Collapsed view:
    - Post title/preview (first 100 chars)
    - Total score badge (color-coded: 0-3 red, 3-5 orange, 5-7 yellow, 7-10 green)
    - Expand button/chevron

    Expanded view (fetches scoring-breakdown on expand):
    - Fetch from `/api/campaigns/${campaignId}/scoring-breakdown?post_id=${postId}`
    - Show 4 key factors as horizontal bar segments or stat cards:
      1. Rhythm Match: rhythm_adherence score (0-10) with label
      2. Vulnerability: vulnerability_weight score (0-10) with label
      3. Formality: formality_match score (0-10) with label
      4. Penalties: combined marketing_jargon_penalty + link_density_penalty with label
    - Each factor shown as: label, score bar (colored), value
    - Below factors: Full post text with PenaltyHighlighter showing inline highlights
    - Loading state while fetching breakdown
    - Cache breakdown data so re-expanding doesn't re-fetch
  </action>
  <verify>
    Run: `cd bc-rao-frontend && npx next build 2>&1 | tail -20` — should compile without errors.

    Verify react-highlight-words: `cd bc-rao-frontend && node -e "require('react-highlight-words'); console.log('react-highlight-words OK')"`

    Verify components exist and are "use client":
    - `bc-rao-frontend/components/analysis/PenaltyHighlighter.tsx`
    - `bc-rao-frontend/components/analysis/PostScoreBreakdown.tsx`
  </verify>
  <done>
    react-highlight-words installed. Three API proxy routes created (analyzed-posts, scoring-breakdown, forbidden-patterns GET+POST). PenaltyHighlighter renders inline colored highlights per severity. PostScoreBreakdown shows 4 key factors with expandable detail and inline penalty highlighting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Analysis page + Blacklist page</name>
  <files>
    bc-rao-frontend/app/dashboard/campaigns/[id]/analysis/page.tsx
    bc-rao-frontend/app/dashboard/campaigns/[id]/blacklist/page.tsx
    bc-rao-frontend/components/analysis/BlacklistTable.tsx
  </files>
  <action>
    **Create `bc-rao-frontend/app/dashboard/campaigns/[id]/analysis/page.tsx`:**
    Dedicated analysis page per LOCKED decision (SEPARATE from Phase 2's post browsing).

    "use client" page.

    Features:
    - Page header: "Post Analysis" with campaign name
    - Fetch analyzed posts from `/api/campaigns/${id}/analyzed-posts`
    - Filter controls (Claude's discretion per LOCKED decision for sort/filter approach):
      - Subreddit dropdown filter (populated from available subreddits)
      - Sort by: Total Score (default desc), Vulnerability, Rhythm Match, Formality, Penalties
      - Sort direction toggle (asc/desc)
    - Post list: Each post rendered as a PostScoreBreakdown component (collapsed by default)
    - Pagination at bottom (page, per_page controls)
    - If no analyzed posts: Show empty state "No analysis data. Run collection first." with link to collect page
    - Loading skeleton while fetching

    Layout: Single column list of expandable post cards. Filters at top. Clean, professional.

    Navigation: Add link to this page from campaign detail page (alongside "View Profiles" link).
    Also add link from profiles comparison page: "View Post Analysis" button.

    **Create `bc-rao-frontend/components/analysis/BlacklistTable.tsx`:**
    "use client" component per LOCKED decision (categories with counts, not raw strings).

    Props: `{ patterns: ForbiddenPattern[], categories: Record<string, number>, onAddPattern: (pattern) => void }`

    Display:
    - Category cards/rows showing: category name, count, severity color
    - Categories: Promotional, Self-referential, Link patterns, Low-effort, Spam indicators, Off-topic, Custom
    - Each category as a collapsible section showing pattern count
    - Per LOCKED decision: show categories and counts ONLY, not raw pattern strings
    - System-detected patterns: show lock icon, no delete button
    - User-added patterns: show in "Custom" category with delete option (future — for now just display)

    **Create `bc-rao-frontend/app/dashboard/campaigns/[id]/blacklist/page.tsx`:**
    Dedicated blacklist page per LOCKED decision (separate page, filterable by subreddit).

    "use client" page.

    Features:
    - Page header: "Forbidden Patterns" with campaign name
    - Subreddit filter dropdown: "All Subreddits" (default) or specific subreddit
    - Fetch from `/api/campaigns/${id}/forbidden-patterns?subreddit={selected}`
    - Render BlacklistTable with category data
    - "Add Custom Pattern" form at bottom:
      - Category dropdown (Promotional, Self-referential, Link patterns, Custom)
      - Pattern text input (the forbidden phrase/word)
      - Optional subreddit scope dropdown (or "All subreddits")
      - Submit button
      - POST to `/api/campaigns/${id}/forbidden-patterns`
      - Refresh list after successful add
    - Per LOCKED decision: users can add custom patterns but cannot remove system-detected ones
    - Navigation: Link to this page from profiles detail page (Forbidden Patterns tab has "View full blacklist" link)
    - Also add link from campaign detail page

    **Update campaign detail page navigation:**
    Read `bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx` and add navigation links/cards for:
    - "Post Analysis" -> `/dashboard/campaigns/${id}/analysis`
    - "Forbidden Patterns" -> `/dashboard/campaigns/${id}/blacklist`
    These should appear alongside existing "Collect Data" and "View Profiles" links.
  </action>
  <verify>
    Run: `cd bc-rao-frontend && npx next build 2>&1 | tail -30` — should compile without errors.

    Verify all pages exist:
    - `bc-rao-frontend/app/dashboard/campaigns/[id]/analysis/page.tsx`
    - `bc-rao-frontend/app/dashboard/campaigns/[id]/blacklist/page.tsx`
    - `bc-rao-frontend/components/analysis/BlacklistTable.tsx`

    Verify campaign detail page has links to analysis and blacklist pages.
  </verify>
  <done>
    Analysis page shows sortable/filterable post list with expandable PostScoreBreakdown cards showing 4 key factors + inline penalty highlighting. Blacklist page shows pattern categories with counts (not raw strings), subreddit filter, and custom pattern form. Campaign detail page links to all Phase 3 pages (profiles, analysis, blacklist).
  </done>
</task>

</tasks>

<verification>
- Analysis page loads and displays post list with scores
- Expanding a post shows 4 scoring factors and inline penalty highlights
- Penalty highlights use red/orange/yellow color coding per severity
- Blacklist page shows pattern categories with counts
- Subreddit filter works on blacklist page
- Custom pattern form submits successfully
- Campaign detail page has navigation to all Phase 3 features
- All pages compile without TypeScript errors
</verification>

<success_criteria>
- Dedicated Analysis page (separate from Phase 2 browsing) with sorting by scoring factors
- PostScoreBreakdown shows rhythm, vulnerability, formality, penalties (3-4 factors)
- Penalties highlighted inline in post text like a linter (red/orange/yellow)
- Dedicated Blacklist page filterable by subreddit
- Pattern categories shown with counts, not raw strings
- Custom patterns addable, system patterns not removable
- Campaign detail page links to profiles, analysis, and blacklist
</success_criteria>

<output>
After completion, create `.planning/phases/03-pattern-engine/03-04-SUMMARY.md`
</output>

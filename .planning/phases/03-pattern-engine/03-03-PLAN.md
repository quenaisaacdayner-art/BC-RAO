---
phase: 03-pattern-engine
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/page.tsx
  - bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/[subreddit]/page.tsx
  - bc-rao-frontend/components/analysis/ISCGauge.tsx
  - bc-rao-frontend/components/analysis/ArchetypePie.tsx
  - bc-rao-frontend/components/analysis/ComparisonTable.tsx
  - bc-rao-frontend/components/analysis/AnalysisProgress.tsx
  - bc-rao-frontend/app/api/campaigns/[id]/community-profiles/route.ts
  - bc-rao-frontend/app/api/campaigns/[id]/community-profile/route.ts
  - bc-rao-frontend/app/api/analysis/[taskId]/progress/route.ts
  - bc-rao-frontend/components/sidebar/nav-items.ts
autonomous: true

must_haves:
  truths:
    - "User can view comparison table of all target subreddits with ISC scores, dominant tones, sample sizes"
    - "User can click into individual subreddit profile with tabbed sections (Summary, Archetypes, Rhythm, Blacklist)"
    - "ISC score shown as number + tier label with color gauge (e.g., '7.8 - Very High Sensitivity')"
    - "Archetype distribution shown as pie/donut chart"
    - "SSE progress tracking shows analysis progress after collection completes"
    - "Toast notification 'Analysis complete' with link to profiles when analysis finishes"
    - "Subreddits with insufficient data show 'Need more data' instead of profile"
  artifacts:
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/page.tsx"
      provides: "Community profiles comparison table entry point"
      min_lines: 60
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/[subreddit]/page.tsx"
      provides: "Tabbed individual subreddit profile detail page"
      min_lines: 80
    - path: "bc-rao-frontend/components/analysis/ISCGauge.tsx"
      provides: "ISC score visualization with color gauge and tier label"
      min_lines: 30
    - path: "bc-rao-frontend/components/analysis/ArchetypePie.tsx"
      provides: "Donut chart for archetype distribution"
      min_lines: 30
    - path: "bc-rao-frontend/components/analysis/ComparisonTable.tsx"
      provides: "Subreddit comparison table with sortable columns"
      min_lines: 50
    - path: "bc-rao-frontend/components/analysis/AnalysisProgress.tsx"
      provides: "SSE progress tracker for analysis pipeline"
      min_lines: 40
  key_links:
    - from: "bc-rao-frontend/components/analysis/AnalysisProgress.tsx"
      to: "/api/analysis/[taskId]/progress"
      via: "EventSource SSE connection"
      pattern: "new EventSource"
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/page.tsx"
      to: "/api/campaigns/[id]/community-profiles"
      via: "fetch in useEffect"
      pattern: "fetch.*community-profiles"
    - from: "bc-rao-frontend/components/analysis/ISCGauge.tsx"
      to: "recharts"
      via: "PieChart for gauge visualization"
      pattern: "from.*recharts.*import"
---

<objective>
Build the community profiles frontend: comparison table as entry point, individual subreddit profile detail with tabbed sections, ISC gauge and archetype pie chart visualizations, and SSE-based analysis progress tracking with toast notification.

Purpose: Users need to see community intelligence for their target subreddits — ISC sensitivity levels, dominant patterns, archetype distributions, and rhythm data. This is the primary output of the Pattern Engine that guides content generation strategy.

Output: Profiles pages with comparison table and tabbed detail, chart components, analysis progress tracker, and API proxy routes.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pattern-engine/03-RESEARCH.md
@.planning/phases/03-pattern-engine/03-CONTEXT.md
@.planning/phases/03-pattern-engine/03-02-SUMMARY.md
@bc-rao-frontend/lib/api.ts
@bc-rao-frontend/components/sidebar/nav-items.ts
@bc-rao-frontend/app/api/collection/[taskId]/progress/route.ts
@bc-rao-frontend/components/collection/ProgressTracker.tsx
@bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts + API proxy routes + analysis progress component</name>
  <files>
    bc-rao-frontend/app/api/campaigns/[id]/community-profiles/route.ts
    bc-rao-frontend/app/api/campaigns/[id]/community-profile/route.ts
    bc-rao-frontend/app/api/analysis/[taskId]/progress/route.ts
    bc-rao-frontend/components/analysis/AnalysisProgress.tsx
  </files>
  <action>
    **Install frontend dependencies:**
    ```bash
    cd bc-rao-frontend && npm install recharts
    ```
    Note: react-highlight-words is installed in Plan 04 (that plan uses it, not this one).

    **Install shadcn/ui Tabs component** (needed for profile detail page):
    ```bash
    cd bc-rao-frontend && npx shadcn@latest add tabs -y
    ```

    **Create `bc-rao-frontend/app/api/campaigns/[id]/community-profiles/route.ts`:**
    Next.js API route that proxies to FastAPI `GET /v1/analysis/campaigns/{id}/community-profiles`.
    Follow the exact same proxy pattern used in `app/api/campaigns/[id]/posts/route.ts`:
    - Extract auth token from Supabase session cookies
    - Forward request to FastAPI with Authorization header
    - Return JSON response

    **Create `bc-rao-frontend/app/api/campaigns/[id]/community-profile/route.ts`:**
    Proxy to FastAPI `GET /v1/analysis/campaigns/{id}/community-profile?subreddit={subreddit}`.
    Pass through the `subreddit` query parameter from the incoming request URL.

    **Create `bc-rao-frontend/app/api/analysis/[taskId]/progress/route.ts`:**
    SSE proxy route for analysis progress. Follow the EXACT same pattern as `app/api/collection/[taskId]/progress/route.ts`:
    - GET handler that proxies to FastAPI SSE endpoint at `GET /v1/analysis/{taskId}/progress`
    - Stream response with text/event-stream content type
    - No auth required (task_id is bearer token)

    **Create `bc-rao-frontend/components/analysis/AnalysisProgress.tsx`:**
    "use client" component. Similar to collection ProgressTracker but for analysis:

    Props: `{ campaignId: string, taskId: string, onComplete: () => void }`

    - Connect to `/api/analysis/${taskId}/progress` via EventSource
    - Display progress: "Analyzing post 47/230..." (from SSE data)
    - Show current step name (nlp_analysis, scoring, profiling)
    - Show progress bar (current / total)
    - On "complete" event: Call `onComplete()` callback. Show toast notification:
      ```
      title: "Analysis complete"
      description: "Community profiles are ready to view"
      action: Link to `/dashboard/campaigns/${campaignId}/profiles`
      ```
      Use sonner toast or shadcn toast (check what's already installed — the collection page may use a pattern to follow).
    - On "error" event: Show error toast
    - CRITICAL: Close EventSource in useEffect cleanup return
    - Handle "insufficient_data" subreddit warnings in progress events — display them as yellow warning badges
  </action>
  <verify>
    Run: `cd bc-rao-frontend && npx next build 2>&1 | tail -20` — should compile without TypeScript errors.

    Verify recharts installed: `cd bc-rao-frontend && node -e "require('recharts'); console.log('recharts OK')"`

    Verify files exist and have correct structure.
  </verify>
  <done>
    Recharts and Tabs installed. Three API proxy routes created (community-profiles list, single profile, analysis SSE progress). AnalysisProgress component connects via EventSource with toast notification on completion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Community profiles pages with comparison table + tabbed detail + chart components</name>
  <files>
    bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/page.tsx
    bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/[subreddit]/page.tsx
    bc-rao-frontend/components/analysis/ISCGauge.tsx
    bc-rao-frontend/components/analysis/ArchetypePie.tsx
    bc-rao-frontend/components/analysis/ComparisonTable.tsx
    bc-rao-frontend/components/sidebar/nav-items.ts
  </files>
  <action>
    **Create `bc-rao-frontend/components/analysis/ISCGauge.tsx`:**
    "use client" component. ISC score visualization per LOCKED decision.

    Props: `{ score: number, tier: string }`

    Display:
    - Large number: "7.8" (score)
    - Tier label with color: "Very High Sensitivity"
    - Color gauge/bar underneath showing where score falls on 1-10 scale
    - Use Recharts PieChart as a half-gauge (semi-circle):
      - Fill portion colored by tier: green (1-3), yellow (3-5), orange (5-7), red (7-10)
      - Or simpler: Use a colored progress bar with gradient
    - Color coding per tier:
      - Low (1-3): green-500
      - Moderate (3-5): yellow-500
      - High (5-7): orange-500
      - Very High (7-10): red-500

    **Create `bc-rao-frontend/components/analysis/ArchetypePie.tsx`:**
    "use client" component. Donut chart per LOCKED decision.

    Props: `{ distribution: { archetype: string; count: number }[] }`

    Use Recharts PieChart with:
    - innerRadius=60, outerRadius=100 (donut style)
    - Colors: Journey=#3B82F6 (blue), ProblemSolution=#10B981 (green), Feedback=#F59E0B (amber), Unclassified=#6B7280 (gray)
    - Legend below chart
    - Responsive container
    - Label showing count on each segment

    **Create `bc-rao-frontend/components/analysis/ComparisonTable.tsx`:**
    "use client" component. Comparison table per LOCKED decision (entry point).

    Props: `{ profiles: CommunityProfile[], campaignId: string }`

    Columns:
    - Subreddit (link to detail page)
    - ISC Score (with color badge matching tier)
    - Dominant Tone
    - Formality Level (formatted as Low/Medium/High)
    - Sample Size
    - Archetypes (mini summary — e.g., "Journey: 45%, PS: 35%")
    - Last Analyzed (relative time)

    Use shadcn Table component. Click row navigates to `/dashboard/campaigns/${campaignId}/profiles/${subreddit}`.
    Sort by ISC score by default (highest sensitivity first).

    **Create `bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/page.tsx`:**
    Profiles comparison page (entry point per LOCKED decision).

    - Fetch community profiles from `/api/campaigns/${id}/community-profiles`
    - If no profiles exist: Show empty state "No analysis data yet. Run collection to start." with link to collect page
    - If analysis is running (check via campaign metadata or query param): Show AnalysisProgress component
    - If profiles exist: Render ComparisonTable
    - Page header: "Community Profiles" with campaign name
    - Show subreddits with insufficient data as grayed-out rows with "Need more data — collect with wider criteria" message (per LOCKED decision)

    **Create `bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/[subreddit]/page.tsx`:**
    Individual subreddit profile detail with tabbed sections per LOCKED decision.

    - Fetch single profile from `/api/campaigns/${id}/community-profile?subreddit=${subreddit}`
    - Page header: "r/{subreddit} Community Profile" with back link to comparison table

    Tabs (using shadcn Tabs component):
    1. **Summary** tab (default):
       - ISCGauge component showing score + tier
       - Key metrics grid: sample_size, dominant_tone, formality_level, avg_sentence_length
       - Top success hooks (first sentences of highest-scoring posts)

    2. **Archetypes** tab:
       - ArchetypePie donut chart
       - List of archetypes with counts and percentages
       - Brief description of each archetype's characteristics

    3. **Rhythm** tab (Claude's discretion on visualization):
       - Average sentence length with comparison to general Reddit average (~15 tokens)
       - Sentence length variability (std dev — high = varied rhythm, low = monotone)
       - Formality level with context ("This community writes at a {grade} reading level")
       - Use simple stat cards with Recharts BarChart showing sentence length distribution if data available

    4. **Forbidden Patterns** tab:
       - Pattern categories with counts (per LOCKED decision: categories only, not raw strings)
       - Color-coded severity badges (high=red, medium=orange, low=yellow)
       - Link to dedicated blacklist page: "View full blacklist"
       - Note: This is a summary view. Full management is on the blacklist page (Plan 04).

    **Modify `bc-rao-frontend/components/sidebar/nav-items.ts`:**
    The sidebar is global — do NOT add campaign-specific routes here. Community profiles are accessed from within campaign detail pages. No sidebar change needed unless adding a global "Analysis" or "Profiles" top-level nav. Per the existing pattern, keep campaign-scoped pages under campaign detail. Leave nav-items unchanged — profiles are reached via campaign detail navigation.

    HOWEVER: Update the campaign detail page (`app/dashboard/campaigns/[id]/page.tsx`) to add a "Community Profiles" link/card if analysis is complete. Read the current campaign detail page first to understand its structure, then add a navigation card/button to profiles page. If the page has a navigation section, add "View Profiles" there.
  </action>
  <verify>
    Run: `cd bc-rao-frontend && npx next build 2>&1 | tail -30` — should compile without TypeScript errors.

    Verify all pages exist:
    - `bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/page.tsx`
    - `bc-rao-frontend/app/dashboard/campaigns/[id]/profiles/[subreddit]/page.tsx`

    Verify chart components:
    - `bc-rao-frontend/components/analysis/ISCGauge.tsx`
    - `bc-rao-frontend/components/analysis/ArchetypePie.tsx`
    - `bc-rao-frontend/components/analysis/ComparisonTable.tsx`
  </verify>
  <done>
    Comparison table shows all subreddits with ISC scores, tones, and archetypes. Clicking a row opens tabbed profile detail with Summary (ISC gauge, key metrics), Archetypes (donut chart), Rhythm (sentence analysis), and Forbidden Patterns (category counts). Insufficient data subreddits show "Need more data" message. Campaign detail page links to profiles.
  </done>
</task>

</tasks>

<verification>
- Profiles comparison page loads and displays table
- Individual profile detail page has 4 tabs with correct content
- ISC gauge shows colored visualization with tier label
- Archetype pie chart renders as donut with correct colors
- Analysis progress shows SSE updates during analysis
- Toast notification appears on analysis completion with link
- Insufficient data subreddits show appropriate warning
- All pages compile without TypeScript errors
</verification>

<success_criteria>
- Comparison table entry point shows all subreddits with ISC, tone, formality, sample size
- Tabbed detail page: Summary, Archetypes, Rhythm, Forbidden Patterns tabs all render
- ISC gauge shows score + tier + color coding
- Archetype distribution shown as donut chart
- Analysis SSE progress tracking works with toast on completion
- Insufficient data blocking with "Need more data" message
</success_criteria>

<output>
After completion, create `.planning/phases/03-pattern-engine/03-03-SUMMARY.md`
</output>

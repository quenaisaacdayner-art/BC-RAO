---
phase: 04-draft-generation
plan: 05
type: execute
wave: 4
depends_on: ["04-03", "04-04"]
files_modified:
  - bc-rao-frontend/components/dashboard/StageIndicator.tsx
  - bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx
  - bc-rao-frontend/lib/campaign-stages.ts
autonomous: true

must_haves:
  truths:
    - "Each campaign shows a 4-stage progress indicator (Project Briefing, Strategic Selection, Community Intelligence, Alchemical Transmutation)"
    - "Stages enforce linear progression — users cannot skip to generation before completing collection and analysis"
    - "Stage 4 (Alchemical Transmutation) shows generate button and draft list on campaign page"
    - "Auto-advance toast notifications appear when prerequisites for next stage are met"
  artifacts:
    - path: "bc-rao-frontend/components/dashboard/StageIndicator.tsx"
      provides: "Per-campaign 4-stage linear progression indicator"
      min_lines: 50
    - path: "bc-rao-frontend/lib/campaign-stages.ts"
      provides: "Stage computation logic and URL mapping"
      min_lines: 30
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx"
      provides: "Updated campaign detail with stage indicator, draft section"
      min_lines: 100
  key_links:
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx"
      to: "bc-rao-frontend/components/dashboard/StageIndicator.tsx"
      via: "Renders StageIndicator with computed stage data"
      pattern: "StageIndicator"
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx"
      to: "bc-rao-frontend/lib/campaign-stages.ts"
      via: "Uses computeStages to determine current stage"
      pattern: "computeStages"
    - from: "bc-rao-frontend/components/dashboard/StageIndicator.tsx"
      to: "sonner"
      via: "Toast notifications for stage auto-advance"
      pattern: "toast\\.success"
---

<objective>
Add the 4-stage campaign journey indicator (Project Briefing, Strategic Selection, Community Intelligence, Alchemical Transmutation) to the campaign detail page, enforce linear progression, and update the campaign page to include Stage 4 content (generate button + recent drafts).

Purpose: The stage indicator guides users through the complete workflow, preventing them from jumping to generation before completing data collection and analysis. This is the dashboard journey experience that ties the entire product loop together (DASH-01 through DASH-04).

Output: StageIndicator component, stage computation utility, updated campaign detail page with stages and Stage 4 draft section.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-draft-generation/04-CONTEXT.md
@.planning/phases/04-draft-generation/04-03-SUMMARY.md
@.planning/phases/04-draft-generation/04-04-SUMMARY.md
@bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stage computation utility and StageIndicator component</name>
  <files>
    bc-rao-frontend/lib/campaign-stages.ts
    bc-rao-frontend/components/dashboard/StageIndicator.tsx
  </files>
  <action>
    Create `lib/campaign-stages.ts`:
    - Define CampaignStage interface: { id: number, name: string, description: string, completed: boolean, active: boolean, url: string }
    - Define the 4 stages:
      1. "Project Briefing" — completed when campaign has product_context + keywords + target_subreddits
      2. "Strategic Selection" — completed when campaign has posts_collected > 0 (collection done)
      3. "Community Intelligence" — completed when campaign has community profiles (analysis done)
      4. "Alchemical Transmutation" — completed when campaign has drafts_generated > 0
    - `computeStages(campaign)` function: takes campaign data (with stats: posts_collected, drafts_generated and a hasProfiles boolean), returns CampaignStage[]
    - `getCurrentStage(stages)`: returns the first non-completed stage's id (or 4 if all complete)
    - `getStageUrl(stageId, campaignId)`: maps stage to URL:
      - 1 -> /dashboard/campaigns/{id}/edit (Project Briefing = campaign setup)
      - 2 -> /dashboard/campaigns/{id}/collect (Strategic Selection = data collection)
      - 3 -> /dashboard/campaigns/{id}/profiles (Community Intelligence = analysis results)
      - 4 -> /dashboard/campaigns/{id}/drafts (Alchemical Transmutation = generation)
    - Enforce linear progression: a stage is "active" only if all previous stages are completed

    Create `components/dashboard/StageIndicator.tsx`:
    - Per Claude's discretion (from CONTEXT.md): badge-style indicator with check icons
    - Props: stages (CampaignStage[]), currentStage (number), campaignId (string)
    - Horizontal layout on desktop (flex row), vertical on mobile (flex col)
    - Each stage rendered as a badge:
      - Completed: green background, check icon, clickable (links to stage URL)
      - Active (current): blue background, pulsing dot or highlighted border, clickable
      - Locked (future): gray background, lock icon, NOT clickable, tooltip "Complete previous stages first"
    - Chevron arrows between stages (horizontal) or down arrows (vertical)
    - Per user decision: auto-advance toast notification
      - useEffect watches stages array: when a stage transitions to completed AND next stage exists, fire toast.success:
        - Stage 1 complete: "Project Briefing complete - you can now collect data"
        - Stage 2 complete: "Strategic Selection complete - you can now view Community Intelligence"
        - Stage 3 complete: "Community Intelligence complete - you can now generate drafts"
      - Toast includes action button "Continue" that navigates to next stage URL
      - Use Sonner toast (already in stack)
    - Uses shadcn/ui Badge, Lucide icons (Check, Lock, ChevronRight, ChevronDown)
  </action>
  <verify>
    Check both files exist. Verify computeStages returns 4 stages. Verify StageIndicator renders badges with correct states.
  </verify>
  <done>
    Stage computation correctly determines progress based on campaign data. StageIndicator renders badge-style stages with completed/active/locked states. Auto-advance toast fires when stage transitions to completed. Linear progression enforced (locked stages not clickable).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update campaign detail page with stages and Stage 4 content</name>
  <files>
    bc-rao-frontend/app/dashboard/campaigns/[id]/page.tsx
  </files>
  <action>
    Update the existing campaign detail page (`app/dashboard/campaigns/[id]/page.tsx`) to add:

    1. **Stage Indicator at top** (below campaign name, above quick action cards):
       - Fetch community profile count for the campaign (need to know if analysis is done) via /api/campaigns/{id}/community-profiles
       - Compute stages using computeStages(campaign, hasProfiles)
       - Render StageIndicator component

    2. **Stage 4 section** (new card section, below existing quick actions):
       - Title: "Alchemical Transmutation" with sparkle/flask icon
       - Show only when Stage 3 is completed (community profiles exist)
       - When Stage 3 NOT completed: show locked message "Complete Community Intelligence first to unlock draft generation"
       - When unlocked:
         - "Generate New Draft" primary button linking to /dashboard/campaigns/{id}/drafts/new
         - Recent drafts list (last 3 drafts) with status badges, fetched from /api/campaigns/{id}/drafts?limit=3
         - "View All Drafts" link to /dashboard/campaigns/{id}/drafts
         - If no drafts yet: "No drafts generated yet. Start by generating your first draft."

    3. **Add Draft generation quick action card** to the existing 3-card grid (making it 4 cards):
       - Purple icon (Wand2 or Sparkles from Lucide)
       - Title: "Draft Generation"
       - Description: "Generate conditioned posts for Reddit"
       - Links to /dashboard/campaigns/{id}/drafts
       - Visually disabled (grayed out) if Stage 3 not completed

    4. **Keep all existing functionality** (product context, keywords, subreddits, statistics, metadata cards, edit/delete buttons). Only ADD the stage indicator and Stage 4 section.

    Note: The campaign stats already show drafts_generated count (from Phase 1). The stats card remains unchanged.
  </action>
  <verify>
    Load the campaign detail page. Verify StageIndicator renders at top. Verify Stage 4 section appears conditionally based on analysis completion. Verify new Draft Generation card in quick actions grid.
  </verify>
  <done>
    Campaign detail page shows 4-stage progress indicator at top. Stage 4 section shows generate button and recent drafts when unlocked (after analysis). Draft Generation card added to quick actions. Linear progression enforced - generation locked until Community Intelligence complete. All existing campaign detail functionality preserved.
  </done>
</task>

</tasks>

<verification>
1. StageIndicator renders on campaign detail page with correct stage states
2. Stages compute correctly based on campaign data (posts_collected, hasProfiles, drafts_generated)
3. Stage 4 locked when no community profiles exist
4. Stage 4 unlocked with generate button when profiles exist
5. Auto-advance toast fires when stage completes
6. Recent drafts display in Stage 4 section
7. Draft Generation card in quick actions grid
8. All existing campaign detail page functionality still works
</verification>

<success_criteria>
- Campaign page shows 4-stage journey indicator
- Linear progression enforced (can't skip stages)
- Stage 4 shows generate button + recent drafts when unlocked
- Auto-advance toast notifications on stage completion
- Stage indicator responsive (horizontal desktop, vertical mobile)
- Existing campaign detail features preserved
</success_criteria>

<output>
After completion, create `.planning/phases/04-draft-generation/04-05-SUMMARY.md`
</output>

---
phase: 04-draft-generation
plan: 04
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/[draftId]/edit/page.tsx
  - bc-rao-frontend/app/api/drafts/[draftId]/route.ts
  - bc-rao-frontend/app/api/drafts/[draftId]/regenerate/route.ts
  - bc-rao-frontend/components/drafts/DraftEditor.tsx
  - bc-rao-frontend/components/drafts/ScoreSidebar.tsx
  - bc-rao-frontend/components/drafts/DraftActions.tsx
  - bc-rao-frontend/components/drafts/CopyButton.tsx
autonomous: true

must_haves:
  truths:
    - "User can view and edit draft text in a full-page editor with scores sidebar"
    - "Sidebar shows vulnerability and rhythm match scores as radial gauges"
    - "User can Approve, Discard, Regenerate (with feedback), or Copy to clipboard"
    - "Scores reflect generated draft only — editing is free-form with no re-scoring"
    - "Copy to clipboard copies current edited text for pasting into Reddit"
  artifacts:
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/[draftId]/edit/page.tsx"
      provides: "Full-page draft editor route"
      min_lines: 40
    - path: "bc-rao-frontend/components/drafts/DraftEditor.tsx"
      provides: "Editor layout with textarea left and sidebar right"
      min_lines: 60
    - path: "bc-rao-frontend/components/drafts/ScoreSidebar.tsx"
      provides: "Vulnerability and rhythm match radial gauges plus metadata"
      min_lines: 50
    - path: "bc-rao-frontend/components/drafts/DraftActions.tsx"
      provides: "Approve, Discard, Regenerate, Copy action buttons"
      min_lines: 40
    - path: "bc-rao-frontend/components/drafts/CopyButton.tsx"
      provides: "Copy to clipboard with visual feedback"
      min_lines: 20
  key_links:
    - from: "bc-rao-frontend/components/drafts/DraftEditor.tsx"
      to: "bc-rao-frontend/components/drafts/ScoreSidebar.tsx"
      via: "Renders ScoreSidebar as right panel"
      pattern: "ScoreSidebar"
    - from: "bc-rao-frontend/components/drafts/DraftActions.tsx"
      to: "/api/drafts/[draftId]"
      via: "PATCH for approve/discard, POST for regenerate"
      pattern: "fetch.*drafts"
    - from: "bc-rao-frontend/components/drafts/ScoreSidebar.tsx"
      to: "bc-rao-frontend/components/analysis/ISCGauge.tsx"
      via: "Reuses ISCGauge component for radial gauges"
      pattern: "ISCGauge"
---

<objective>
Build the full-page draft editor with text editing area on the left and scores/actions sidebar on the right. Includes radial gauges for vulnerability and rhythm match scores (reusing ISCGauge pattern), four action buttons (Approve, Discard, Regenerate with feedback, Copy to clipboard), and metadata display.

Purpose: The draft editor is where users review, refine, and approve generated content before posting to Reddit. The scores sidebar shows how well the draft matches community behavioral DNA. Copy to clipboard is the final step before pasting into Reddit.

Output: Draft editor page, ScoreSidebar with gauges, DraftActions with all four buttons, CopyButton component.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-draft-generation/04-02-SUMMARY.md
@.planning/phases/04-draft-generation/04-CONTEXT.md
@bc-rao-frontend/components/analysis/ISCGauge.tsx
@bc-rao-frontend/lib/api.ts
@bc-rao-frontend/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Next.js API proxy routes for draft operations</name>
  <files>
    bc-rao-frontend/app/api/drafts/[draftId]/route.ts
    bc-rao-frontend/app/api/drafts/[draftId]/regenerate/route.ts
  </files>
  <action>
    Create `app/api/drafts/[draftId]/route.ts`:
    - PATCH handler: authenticate user, proxy to FastAPI `PATCH /drafts/${draftId}` with body (status, user_edits)
    - DELETE handler: authenticate user, proxy to FastAPI `DELETE /drafts/${draftId}`
    - GET handler: authenticate user, proxy to FastAPI `GET /drafts/${draftId}` (need single draft fetch for editor page load)
    - Follow existing proxy patterns from other campaign routes

    Create `app/api/drafts/[draftId]/regenerate/route.ts`:
    - POST handler: authenticate user, proxy to FastAPI `POST /drafts/${draftId}/regenerate` with body (feedback)
    - Return task_id for SSE streaming (same pattern as generation)
  </action>
  <verify>
    Check both route.ts files exist with proper PATCH/DELETE/GET and POST handlers.
  </verify>
  <done>
    Proxy routes for single draft operations (get, update, delete) and regeneration created. Auth forwarding follows established pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Draft editor with score sidebar and action buttons</name>
  <files>
    bc-rao-frontend/components/drafts/CopyButton.tsx
    bc-rao-frontend/components/drafts/ScoreSidebar.tsx
    bc-rao-frontend/components/drafts/DraftActions.tsx
    bc-rao-frontend/components/drafts/DraftEditor.tsx
    bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/[draftId]/edit/page.tsx
  </files>
  <action>
    Create `components/drafts/CopyButton.tsx`:
    - Props: text (string)
    - Uses navigator.clipboard.writeText() (NOT a library)
    - Shows Copy icon, changes to Check icon with "Copied!" text for 2 seconds after copy
    - Fallback for older browsers: textarea-based copy
    - Uses shadcn/ui Button with variant="outline"

    Create `components/drafts/ScoreSidebar.tsx`:
    - Props: vulnerabilityScore (number), rhythmMatchScore (number), metadata (object with model_used, token_count, token_cost_usd, archetype, subreddit, created_at)
    - Per user decision: radial gauges consistent with ISCGauge from Phase 3
    - Reuse ISCGauge component from components/analysis/ISCGauge.tsx for both gauges
    - Vulnerability gauge: score 0-10, tiers: "Very High" (8+), "High" (6+), "Moderate" (4+), "Low" (<4)
    - Rhythm Match gauge: score 0-10, tiers: "Excellent Match" (8+), "Good Match" (6+), "Fair Match" (4+), "Poor Match" (<4)
    - Below gauges: metadata section with model_used, token_count, archetype badge, subreddit, created_at formatted
    - Note text at bottom: "Scores reflect the generated draft only. Editing is free-form."

    Create `components/drafts/DraftActions.tsx`:
    - Props: draftId (string), campaignId (string), editedBody (string), onApprove, onDiscard, onRegenerate, isProcessing (boolean)
    - Per user decision: Four actions exactly:
      1. Approve button (primary variant, saves as "approved" status via PATCH)
      2. Copy to Clipboard (renders CopyButton with editedBody)
      3. Regenerate button (outline variant, toggles feedback textarea)
         - When clicked: shows textarea for optional feedback + "Generate New Version" submit button
         - On submit: calls onRegenerate(feedback)
      4. Discard button (destructive variant, sets status to "discarded" via PATCH)
    - All buttons disabled when isProcessing

    Create `components/drafts/DraftEditor.tsx`:
    - Props: draft (object with all draft fields), onApprove, onDiscard, onRegenerate
    - Per user decision: Full-page layout with grid: `grid-cols-1 lg:grid-cols-[1fr_320px]`
    - Left panel: "Draft Editor" heading, plain textarea (per Claude's discretion: plain textarea, not rich editor) with flex-1 to fill height, monospace font
    - editedBody state initialized from draft.body
    - Right panel: ScoreSidebar + DraftActions, separated by Separator
    - Per user decision: No live re-scoring — scores from draft object only

    Create `app/dashboard/campaigns/[id]/drafts/[draftId]/edit/page.tsx`:
    - Load draft data via GET /api/drafts/${draftId}
    - Render DraftEditor with loaded draft
    - onApprove: PATCH /api/drafts/${draftId} with status="approved", user_edits=editedBody, then redirect to draft list with success toast
    - onDiscard: PATCH /api/drafts/${draftId} with status="discarded", then redirect to draft list with info toast
    - onRegenerate: POST /api/drafts/${draftId}/regenerate with feedback, get task_id, open EventSource for streaming, on complete redirect to new draft editor
    - Loading state while fetching draft
    - Clean up EventSource on unmount if regeneration in progress
  </action>
  <verify>
    Check all component files exist. Verify DraftEditor renders grid layout with ScoreSidebar and DraftActions. Verify CopyButton uses navigator.clipboard API. Verify edit page loads draft and handles all four actions.
  </verify>
  <done>
    Full-page draft editor displays draft text on left with plain textarea and score sidebar on right with radial gauges. Four actions work: Approve (saves as approved + redirect), Discard (saves as discarded + redirect), Regenerate (opens feedback textarea, triggers new generation), Copy (copies current text to clipboard with visual feedback). Scores reflect generated draft only, editing is free-form.
  </done>
</task>

</tasks>

<verification>
1. Draft editor page renders with two-column layout (text left, sidebar right)
2. Vulnerability and rhythm match gauges display using ISCGauge component
3. Copy to clipboard works and shows confirmation
4. Approve saves draft as approved and redirects
5. Discard saves draft as discarded and redirects
6. Regenerate shows feedback textarea and triggers new generation
7. Metadata displays model_used, token_count, archetype, subreddit
</verification>

<success_criteria>
- Full-page editor with draft text left, scores/metadata right
- Radial gauges match ISCGauge style from Phase 3
- All four actions functional (Approve, Discard, Regenerate, Copy)
- No re-scoring on manual edits
- Regeneration streams via SSE with EventSource cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/04-draft-generation/04-04-SUMMARY.md`
</output>

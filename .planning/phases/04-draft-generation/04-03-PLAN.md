---
phase: 04-draft-generation
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - bc-rao-frontend/app/api/campaigns/[id]/drafts/generate/route.ts
  - bc-rao-frontend/app/api/campaigns/[id]/drafts/route.ts
  - bc-rao-frontend/app/api/campaigns/[id]/drafts/generate/stream/[taskId]/route.ts
  - bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/page.tsx
  - bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/new/page.tsx
  - bc-rao-frontend/components/drafts/GenerationForm.tsx
  - bc-rao-frontend/components/drafts/ISCGatingWarning.tsx
  - bc-rao-frontend/components/drafts/DraftCard.tsx
autonomous: true

must_haves:
  truths:
    - "User can select subreddit, archetype, and optional context on a single form page and trigger generation"
    - "ISC gating warning appears when subreddit ISC > 7.5 and auto-switches to Feedback archetype"
    - "User sees real-time progress during generation via SSE streaming"
    - "User can view list of generated drafts for a campaign filtered by status and subreddit"
    - "Subreddits without community profiles show warning and still allow generation"
  artifacts:
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/new/page.tsx"
      provides: "Single-form generation page"
      min_lines: 40
    - path: "bc-rao-frontend/components/drafts/GenerationForm.tsx"
      provides: "Form with subreddit dropdown, archetype selector, context textarea"
      min_lines: 80
    - path: "bc-rao-frontend/components/drafts/ISCGatingWarning.tsx"
      provides: "Inline warning banner for high ISC communities"
      min_lines: 20
    - path: "bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/page.tsx"
      provides: "Draft list page with filtering"
      min_lines: 60
  key_links:
    - from: "bc-rao-frontend/components/drafts/GenerationForm.tsx"
      to: "/api/campaigns/[id]/drafts/generate"
      via: "fetch POST to trigger generation"
      pattern: "fetch.*drafts/generate"
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/new/page.tsx"
      to: "/api/campaigns/[id]/drafts/generate/stream/[taskId]"
      via: "EventSource for SSE streaming"
      pattern: "EventSource"
    - from: "bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/page.tsx"
      to: "/api/campaigns/[id]/drafts"
      via: "fetch GET for draft list"
      pattern: "fetch.*drafts"
---

<objective>
Build the frontend generation form (single page with subreddit dropdown, archetype selector, context textarea), ISC gating UX (inline warning + auto-switch), SSE streaming during generation, and draft list page with filtering.

Purpose: This is the user-facing interface for Module 3. Users need a simple form to trigger generation with real-time feedback, and a list to browse their generated drafts. ISC gating prevents users from selecting risky archetypes for sensitive communities.

Output: Generation form page, ISC gating warning component, SSE proxy routes, draft list page with cards.
</objective>

<execution_context>
@C:\Users\quena\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\quena\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-draft-generation/04-02-SUMMARY.md
@.planning/phases/04-draft-generation/04-CONTEXT.md
@bc-rao-frontend/app/dashboard/campaigns/[id]/collect/page.tsx
@bc-rao-frontend/app/api/campaigns/[id]/collect/route.ts
@bc-rao-frontend/app/api/campaigns/[id]/community-profiles/route.ts
@bc-rao-frontend/components/analysis/ISCGauge.tsx
@bc-rao-frontend/lib/api.ts
@bc-rao-frontend/lib/supabase/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Next.js API proxy routes for draft generation</name>
  <files>
    bc-rao-frontend/app/api/campaigns/[id]/drafts/generate/route.ts
    bc-rao-frontend/app/api/campaigns/[id]/drafts/route.ts
    bc-rao-frontend/app/api/campaigns/[id]/drafts/generate/stream/[taskId]/route.ts
  </files>
  <action>
    Create 3 Next.js API routes following the established SSE proxy pattern from collection routes:

    1. `app/api/campaigns/[id]/drafts/generate/route.ts` — POST proxy
       - Authenticate user (get session from Supabase)
       - Proxy POST to FastAPI: `${BACKEND_URL}/campaigns/${id}/drafts/generate`
       - Forward Authorization header with JWT
       - Return task_id from backend response

    2. `app/api/campaigns/[id]/drafts/route.ts` — GET proxy for draft list
       - Authenticate user
       - Proxy GET to FastAPI: `${BACKEND_URL}/campaigns/${id}/drafts`
       - Forward query params (status, subreddit, limit, offset)
       - Return draft list

    3. `app/api/campaigns/[id]/drafts/generate/stream/[taskId]/route.ts` — SSE proxy
       - Follow exact SSE proxy pattern from `app/api/campaigns/[id]/collect/route.ts` (the GET SSE handler)
       - Proxy SSE from FastAPI: `${BACKEND_URL}/campaigns/${id}/drafts/generate/stream/${taskId}`
       - Stream events through to browser EventSource
       - No authentication required (task_id is bearer token, same as collection pattern)

    Follow the exact patterns from existing proxy routes. Use the same BACKEND_URL env var, same error handling, same response forwarding.
  </action>
  <verify>
    Check files exist and follow proxy pattern: the 3 route.ts files should import NextRequest/NextResponse and use fetch to proxy to BACKEND_URL.
  </verify>
  <done>
    Three Next.js API routes proxy draft generation requests to FastAPI backend. SSE streaming proxy follows established collection pattern. Authentication forwarded on POST/GET, task_id used as bearer for SSE.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generation form page with ISC gating and draft list</name>
  <files>
    bc-rao-frontend/components/drafts/GenerationForm.tsx
    bc-rao-frontend/components/drafts/ISCGatingWarning.tsx
    bc-rao-frontend/components/drafts/DraftCard.tsx
    bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/new/page.tsx
    bc-rao-frontend/app/dashboard/campaigns/[id]/drafts/page.tsx
  </files>
  <action>
    Create `components/drafts/ISCGatingWarning.tsx`:
    - Props: subreddit (string), iscScore (number), iscTier (string)
    - Orange warning banner with AlertTriangle icon
    - Text: "r/{subreddit} has ISC {score}/10 ({tier}). Only Feedback archetype available with zero links."
    - Uses the pattern from 04-RESEARCH.md

    Create `components/drafts/GenerationForm.tsx`:
    - Per user decision: Single form (NOT wizard) with three inputs only
    - Props: campaignSubreddits (string[]), iscData (Record<string, {score: number, tier: string}> — may be partial, not all subreddits have profiles), onSubmit, isGenerating (boolean)
    - React Hook Form with Zod validation:
      - subreddit: z.string().min(1, "Select a subreddit")
      - archetype: z.enum(["Journey", "ProblemSolution", "Feedback"])
      - context: z.string().max(2000).optional()
    - Subreddit dropdown: show ALL campaign subreddits, append "(No profile)" for ones not in iscData
    - When subreddit selected and NO profile exists: show yellow warning "No community profile exists. Will generate with generic defaults."
    - When subreddit selected and ISC > 7.5: show ISCGatingWarning, auto-switch archetype to "Feedback" via form.setValue, disable Journey and ProblemSolution options with "(Blocked: ISC > 7.5)" label
    - Context textarea with character count: "X / 2000 characters"
    - Generate button (disabled when isGenerating, show loading spinner)
    - Use shadcn/ui Form, Select, Textarea, Button components

    Create `components/drafts/DraftCard.tsx`:
    - Props: draft (with id, subreddit, archetype, body preview, vulnerability_score, rhythm_match_score, status, created_at)
    - Card showing: archetype badge, subreddit, body preview (first 150 chars), vulnerability + rhythm scores as small bars, status badge, created_at
    - Click navigates to draft editor: /dashboard/campaigns/{campaignId}/drafts/{draftId}/edit

    Create `app/dashboard/campaigns/[id]/drafts/new/page.tsx`:
    - Load campaign data (get subreddits)
    - Load community profiles for the campaign (to get ISC data per subreddit) via /api/campaigns/{id}/community-profiles
    - Build iscData map from profiles
    - On form submit: POST to /api/campaigns/{id}/drafts/generate
    - On task_id received: open EventSource to /api/campaigns/{id}/drafts/generate/stream/{taskId}
    - Show generation progress: "Loading community profile...", "Building prompt...", "Generating draft..."
    - On "complete" event: redirect to draft editor at /dashboard/campaigns/{id}/drafts/{draft.id}/edit
    - On "error" event: show error toast via Sonner
    - Clean up EventSource on unmount (critical: return () => eventSource.close() in useEffect)

    Create `app/dashboard/campaigns/[id]/drafts/page.tsx`:
    - Load campaign data
    - Fetch drafts via /api/campaigns/{id}/drafts with optional filters
    - Filter controls: status dropdown (all, generated, approved, discarded), subreddit dropdown
    - Render DraftCard grid (responsive: 1 col mobile, 2 cols tablet, 3 cols desktop)
    - Empty state when no drafts: "No drafts yet. Generate your first draft." with link to /drafts/new
    - "Generate New Draft" button at top linking to /drafts/new
  </action>
  <verify>
    Check all component files exist. Verify GenerationForm uses React Hook Form with Zod. Verify ISC gating warning conditionally renders. Verify draft list page fetches from API proxy route.
  </verify>
  <done>
    Generation form shows three inputs (subreddit, archetype, context) on a single page. ISC gating auto-switches to Feedback when ISC > 7.5 with inline warning. No-profile warning shown for subreddits without community profiles. SSE streaming shows real-time progress during generation. Draft list page displays cards with filtering by status and subreddit. EventSource cleaned up on unmount.
  </done>
</task>

</tasks>

<verification>
1. Generation form renders with subreddit dropdown, archetype selector, context textarea
2. ISC > 7.5 shows warning banner and disables Journey/ProblemSolution
3. Subreddits without profiles show yellow warning
4. Context textarea shows character count (X/2000)
5. Generation progress streams via SSE
6. Draft list page loads and filters drafts
7. EventSource closed on component unmount
</verification>

<success_criteria>
- User can fill in single-page form and trigger generation
- ISC gating enforced on frontend (warning + auto-switch)
- Real-time streaming feedback during generation
- Draft list shows all campaign drafts with status/subreddit filters
- Navigation between draft list and generation form works
</success_criteria>

<output>
After completion, create `.planning/phases/04-draft-generation/04-03-SUMMARY.md`
</output>

---
phase: 04.1-draft-generation-anti-ai-optimization
plan: 02
subsystem: generation
tags: [ai-detection, regex-patterns, regeneration-loop, quality-gate, humanization]

# Dependency graph
requires:
  - phase: 04.1-draft-generation-anti-ai-optimization
    plan: 01
    provides: "Positive HUMANIZATION_RULES, structural templates, prompt builder with metadata tracking"
provides:
  - "6 new AI-tell detection patterns (symmetrical-structure, tidy-ending, enumeration, hedge-affirm, generic-descriptor, over-enthusiasm)"
  - "Blocking regeneration loop with MAX_REGENERATION_ATTEMPTS=2 (3 total attempts)"
  - "Escalating anti-pattern feedback injected on retry attempts"
  - "Regeneration metadata (attempts, final pattern count) in generation_params JSONB"
  - "High severity classification for tidy-ending and symmetrical-structure patterns"
affects: [04.1-03-PLAN, generation-service, blacklist-validator]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Blocking quality gate: AI detection triggers regeneration, not just logging"
    - "Escalating feedback: attempt 1 messy instructions, attempt 2 maximum humanization"
    - "Cost accumulation: token_count and token_cost_usd sum across retry attempts"
    - "Graceful degradation: accept best-effort draft after max retries"

key-files:
  created: []
  modified:
    - "bc-rao-api/app/generation/blacklist_validator.py"
    - "bc-rao-api/app/generation/generation_service.py"
    - "bc-rao-api/tests/test_blacklist_validator.py"

key-decisions:
  - "12 total AI-tell patterns (6 original + 6 new) covering symmetrical structure, tidy endings, enumeration, hedge-affirm, generic descriptors, and over-enthusiasm"
  - "MAX_REGENERATION_ATTEMPTS=2 (3 total attempts) to balance quality improvement with cost control"
  - "Escalating feedback: attempt 1 asks for messy writing, attempt 2 demands maximum humanization"
  - "AI-tidy-ending and AI-symmetrical-structure classified as high severity alongside existing high-severity categories"
  - "Token costs accumulated across retries to reflect true generation cost"

patterns-established:
  - "Blocking quality gate: detect_ai_patterns() drives regeneration loop, not informational logging"
  - "Anti-pattern feedback injection: rebuild prompts with escalating humanization instructions on retry"
  - "Regeneration metadata tracking: generation_params stores attempt count and final pattern count"

# Metrics
duration: 6min
completed: 2026-02-13
---

# Phase 04.1 Plan 02: AI Detection Expansion and Blocking Regeneration Loop Summary

**12 AI-tell detection patterns with blocking regeneration loop that auto-retries up to 2 times with escalating anti-pattern feedback**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-13T02:47:51Z
- **Completed:** 2026-02-13T02:53:16Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- Expanded AI_TELL_PATTERNS from 6 to 12 with symmetrical-structure, tidy-ending, enumeration, hedge-affirm, generic-descriptor, and over-enthusiasm detection
- Converted informational-only AI detection into a blocking regeneration loop that auto-retries with escalating anti-pattern feedback
- Added 40 new test cases covering all 6 new patterns plus negative tests (65 total blacklist validator tests)
- Regeneration metadata (attempts, final AI pattern count) stored in generation_params for monitoring

## Task Commits

Each task was committed atomically:

1. **Task 1: Expand AI detection patterns and update tests** - `198af05` (feat)
2. **Task 2: Implement blocking regeneration loop in generation_service.py** - `1ecd2b7` (feat)

## Files Created/Modified
- `bc-rao-api/app/generation/blacklist_validator.py` - Added 6 new AI_TELL_PATTERNS, updated severity mapping for tidy-ending and symmetrical-structure
- `bc-rao-api/app/generation/generation_service.py` - Added MAX_REGENERATION_ATTEMPTS constant, _build_anti_pattern_feedback() helper, blocking regeneration loop wrapping Steps 5-6b, regeneration metadata in generation_params
- `bc-rao-api/tests/test_blacklist_validator.py` - Added 40 new tests across 8 test classes for AI pattern detection

## Decisions Made
- 12 total AI-tell patterns: 6 original + 6 new covering all identified anti-patterns from debug analysis
- MAX_REGENERATION_ATTEMPTS=2: balances quality improvement (3 total attempts) with cost control (prevents infinite retries)
- Escalating feedback approach: attempt 1 encourages messy writing, attempt 2 demands maximum humanization
- High severity for tidy-ending and symmetrical-structure: these are the most obvious AI tells
- Token costs accumulated across retries: generation_params reflects true cost of producing the final draft

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Pre-existing test failure in test_collection_service.py (conftest MockSupabaseClient edge case) is unrelated to our changes. All 137 generation-related tests pass (test_blacklist_validator, test_isc_gating, test_style_extractor, test_style_guide_generator).
- GenerationService constructor requires Supabase connection, so verification used inspect.signature and unbound method calls instead of instantiation.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- AI detection now blocking with automatic regeneration, ready for real-world testing
- Plan 03 (community DNA enrichment) can proceed immediately -- it enriches the prompt inputs that feed into this pipeline
- Regeneration metadata enables monitoring: track how many drafts require retries and at what rate patterns persist

## Self-Check: PASSED

- All 4 files verified present on disk
- Commit `198af05` (Task 1) verified in git log
- Commit `1ecd2b7` (Task 2) verified in git log
- 65 blacklist validator tests pass
- 137 generation-related tests pass

---
*Phase: 04.1-draft-generation-anti-ai-optimization*
*Completed: 2026-02-13*
